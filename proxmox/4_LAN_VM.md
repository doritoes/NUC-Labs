# Install LAN  VM
Next we will install our first VM(s). These are on the Inside/LAN network, located behind our VyOS router. Instructions are provided for a few different systems you might want to install.

NOTE You will need to upload/copy the appropriate ISO file to one of the SR's (storage repositories) configured earlier

IMPORTANT Currently the VyOS router is using NAT to access the outside world. This means that the rest of the hosts in my Lab can't get to the 192.168.100.0/24 network. Buuut the inside network 192.168.100.0/24 can reach the Internet and the rest of my Lab network (NAS, printer, etc).

# Ubuntu Desktop
- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **ubuntu-desktop-lan**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Ubuntu 22.04 desktop ISO from dropdown*
    - Guest OS:
      - Type: Linux
      - Version: 6x - 2.6 Kernel
  - System tab
    - No changes
  - Disks tab
    - Disk size: **20GB**
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 1
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **2048 MB** (2GB)
  - Network tab
    - Bridge: **vmbr1**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > 101 (ubuntu-desktop-lan)
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate windows is opened
- Follow the Install wizard per usual
  - To remove the installation media
    - Back in the main proxmox window, click on the VM, then click hardware
    - Edit the CD/DVD Drive
      - Do not use any media
  - Press Enter to Reboot
- Log in to the console and complete the first time wizard
  - Skip, Skip, No, Next, Done
- Updates
  - Optionally let the Software Updater "Install Now"
  - Or do a manual update
    - `sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y`
- Test the VM
  - Internet access using Firefox
- Configure sharing your desktop
  - See https://askubuntu.com/questions/1482111/remote-desktop-ubuntu-22-04-lts
  - Settings > Sharing
  - Enable the Sharing slider
  - Click Remote Desktop
  - Enable Remote Desktop
  - Enable Remote Control
  - Only Enable Legacy VNC Protocol if you must
  - Under authentication, confirm the username <ins>and password</ins>
    - a random password is set; you might want to change it to something more memorable  
  - BEWARE that remote desktop is disabled when the screen is locked
    - see https://askubuntu.com/questions/1411504/connect-when-remote-desktop-is-on-login-screen-or-screen-locked-without-autolog
    - there are workarounds
- Install qemu-guest-agent
  - https://pve.proxmox.com/wiki/Qemu-guest-agent
  - First install the agent
    - `sudo apt update && sudo apt install -y qemu-guest-agent`
  - Second enable the agent in proxmox
    - Click on the VM
    - Click on Options
    - Edit QEMU Guest Agent: Check Use QEMU GUest Agent
    - Click OK
  - Third Stop and Start the VM (a "restart" or "reboot" is not enough)
- Enable SSH access
  - `sudo apt install -y openssh-server`
  - `sudo systemctl status ssh`
  - To secure it further (enable ufw firewall, etc.) see https://serverastra.com/docs/Tutorials/Setting-Up-and-Securing-SSH-on-Ubuntu-22.04%3A-A-Comprehensive-Guide
- Power down the VM
- Take a Snapshot
  - This is to demonstrate how to take a snapshot and what happens to snapshots when you convert a VM to a template
  - Click on the VM in the left pane
  - Click **Snapshots**
  - Click **Take Snapshot**
    - Name: **initial_build** (no spaces)
  - Home > VMs
  -   - Click the small X to remove the filter, showing ALL VMs including those shut down
  - Click `ubuntu-desktop-lan`
  - Click the Snapshots tab
  - Click **New snapshot**
- Convert to a Template
  - Click on the VM
  - Click **More** > **Convert to Template** (next to start, shutdown, and console)
    - Click **Yes**
    - Read the warning: *unable to create template, because VM contains snapshots**
    - Snapshots > click `initial_build` > Remove > **Yes**
    - Repeat the action to convert to template
    - Note that the VM is still there, but as a template it <ins>can only be cloned</ins>
- Clone a new VM from `ubuntu-desktop-lan`
  - Click on the VM ubuntu-desktop-lab (it should still be powered off)
  - Click More > Clone
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - Mode: **Linked Clone** is recommeded (saves space across all the clones)
      - the other option is Full Clone
    - Name: `desktop-lan`
    - Click **Clone**
- Power on and test the new clone
  - Click on the new VM **desktop-lan**
  - Click **Start**
  - Click **Console**
  - What are the advantages of using DHCP in the lab for these closes and templates?
  - Change hostname
    - View current hostname: `hostnamectl`
    - Set the new hostname: `sudo hostnamectl set-hostname desktop-lan`
    - Optionally set the pretty name: `sudo hostnamectl set-hostname "Ubuntu Desktop on LAN" --pretty`
    - Confirm it has changed: `hostnamectl`
- Optionally create another clone and experiment

# Ubuntu Server
- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **ubuntu-server-lan**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Ubuntu 22.04 server ISO from dropdown*
    - Guest OS:
      - Type: Linux
      - Version: 6x - 2.6 Kernel
  - System tab
    - No changes
  - Disks tab
    - Disk size: **20GB**
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 1
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **2048 MB** (2GB)
  - Network tab
    - Bridge: **vmbr1**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > 103 (ubuntu-server-lan)
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate windows is opened
- Click the Console tab and follow the Install wizard per usual
  - READ CAREFULLY the Guided storage configuration
    - Root / only has **10GB** of the **20GB** allocated
    - Solutions (if in doubt, use Option 1; Option 2 is popular for /var, /var/log, /opt, or /home)
      - Option 1 expand root /
        - Under used devices, locate ubuntu-lv which will be mounted at root /
        - Select it, and then Edit
        - Change the Size to the max value
      - Option 2
        - Select the free space, then Create Logical Volume
        - Adjust the size to use the free space
        - Adjust the mount point (/home by default)
    - Choose Create
  - Recommend checking the box Install OpenSSH server
  - To remove the installation media
    - Back in the main proxmox window, click on the VM, then click hardware
    - Edit the CD/DVD Drive
      - Do not use any media
  - Press Enter to Reboot
- Log in and check the system using Console
  - Is the disk size correct? `df -h`
- Test the VM
  - Updates
    - `sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y`
    - accept the messages (default values OK)
- Install qemu-guest-agent
  - https://pve.proxmox.com/wiki/Qemu-guest-agent
  - First install the agent
    - `sudo apt update && sudo apt install -y qemu-guest-agent`
  - Second enable the agent in proxmox
    - Click on the VM
    - Click on Options
    - Edit QEMU Guest Agent: Check Use QEMU Gyest Agent
    - Click OK
  - Third Stop and Start the VM (a "restart" or "reboot" is not enough)
- Power down the VM
  - 'sudo poweroff'
- Clone a new VM from `ubuntu-server-lan`
  - Click on the VM ubuntu-server-lan (it should still be powered off)
  - Click More > Clone
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - Mode: **Linked Clone** is recommeded (saves space across all the clones)
      - the other option is Full Clone
    - Name: `server-lan`
    - Click **Clone**
- Power on and test the new clone
  - Click on the new VM **server-lan**
  - Click **Start**
  - Click **Console**
  - Change hostname
    - View current hostname: `hostnamectl`
    - Set the new hostname: `sudo hostnamectl set-hostname server-lan`
    - Optionally set the pretty name: `sudo hostnamectl set-hostname "Ubuntu Server on LAN" --pretty`
    - Confirm it has changed: `hostnamectl`
  - How could you use cloning to quickly roll out a number of servers of the same type?

# Windows 10
- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **win10-lan**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Windows 10 ISO from dropdown*
    - Guest OS:
      - Type: **Microsoft Windows**
      - Version: **10/2016/2019**
        - the most recent option is *11/2022/2025*
  - System tab
    - No changes
  - Disks tab
    - Disk size: **128GB**
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 2
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **4096 MB** (4GB)
  - Network tab
    - Bridge: **vmbr1**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > 105 (win10-lan)
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate windows is opened
- Click Console and follow the Install wizard per usual
  - Confirm Language, formats, and keyboard then Next
  - Click **Install now**
  - Activate Windows: Click **I don't have a product key**
  - Select the OS to install: **Windows 10 Pro** (feel free to experiment) and click **Next**
  - Check the box then click **Next**
  - Click **Custom: Install Windows only (advanced)**
  - Accept the installation on Drive 0, click **Next**
  - Wait while the system powers reboots and gradually installs
- When the system boots to "Let's start with region. Is this right?"
  - Remove the installation media
    - Back in the main proxmox window, click on the VM, then click hardware
    - Edit the CD/DVD Drive
      - Do not use any media
  - At the console, press **Shift-F10** to open command prompt
    - `shutdown /t 0 /s`
    - type this exactly, spacing matters
- Clone a new VM from `win10-lan`
  - Click on the VM win10-lan (it should still be powered off)
  - Click More > Clone
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - NOTE There is no "Linked Clone" option
    - Name: `win10-lan-ready`
    - Click **Clone**  
  - Log in complete the setup wizard
    - Start the VM
    - Set region and keyboard layout, skip second keyboard layout
    - Select **Set up for personal use** (feel free to experiment)
    - Click **Offline account** then click **Limited experience**
    - User: **lab**
    - Password: select a password
    - Create security questions for this account: be creative
    - Click **Not now**
    - Privacy: *disable all the settings* and then click **Accept**
    - Experience: be creative and pick one, then click **Accept* (I chose Business)
    - Cortana: Click **Not now**
    - At the screen "Browse the web with the best performing browser on Windows"
      - Click **Continue**
      - Click **Start without your data**
      - <ins>Uncheck</ins> bring over your data and continue
      - Click **Continue without this data**
      - <ins>Uncheck</ins> Make your Microsoft experience more useful and continue
      - Click **Finish**
- Apply Windows Updates (reboots included)
- Enable Remote Desktop (RDP)
  - Start > Settings > System > Remote Desktop
  - Slide to enable and Confirm
- [Install QEMU Guest Agent](Appendix_Install_Guest_Agent_Windows.md)
- Change the hostname to win-10-lan-ready
  - From administrative powershell: `Rename-Computer -NewName win10-lan-ready`
- Shut down the Windows VM
- Clone win10-lan-ready to create more Windows 10 VMs
- Questions to ponder:
  - What are the differences between the two cloning bases we created?
  - Does this affect the Activation required timers?
- Optionally create another VM from each win10-lan and win10-lan-ready and experiment

# Windows 11
IMPORTANT Windows 11 will not install without a TPM.

IMPORTANT If you want to set up using a local account instead of a Microsoft account
- Disconnect Internet during setup
- https://www.elevenforum.com/t/clean-install-windows-11.99/
  - The alternate method provided (Shift-F10 and enter OOBE\BYPASSNRO) didn't work in Lab testing

- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **win11-lan**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Windows 10 ISO from dropdown*
    - Guest OS:
      - Type: **Microsoft Windows**
      - Version: **11/2022/2025**
  - System tab
    - Check **Add TPM**
    - TPM Storage: select **local-lvm**
    - EFI Storage: select **local-lvm**
  - Disks tab
    - Disk size: **128GB**
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 2
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **4096 MB** (4GB)
  - Network tab
    - Bridge: **vmbr1**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > 107 (win11-lan)
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate windows is opened
- You are prompted **Press any key to boot from CD or DVD....**
  - **press any key**
  - if you missed it, stop the VM, start again and try again at the console
- Click Console and follow the Install wizard per usual
  - Confirm Language, formats, and keyboard then Next
  - Click **Install now**
  - Activate Windows: Click **I don't have a product key**
  - Select the OS to install: **Windows 11 Pro** (feel free to experiment) and click **Next**
  - Check the box then click **Next**
  - Click **Custom: Install Windows only (advanced)**
  - Accept the installation on Drive 0, click **Next**
  - Wait while the system powers reboots and gradually installs
- When the system boots to "Let's start with region. Is this right?"
  - Remove the installation media
    - Back in the main proxmox window, click on the VM, then click hardware
    - Edit the CD/DVD Drive
      - Do not use any media
  - At the console, press **Shift-F10** to open command prompt
    - `shutdown /t 0 /s`
    - type this exactly, spacing matters
- Clone a new VM from `win11-lan`
  - Click on the VM win11-lan (it should still be powered off)
  - Click More > Clone
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - NOTE There is no "Linked Clone" option
    - Name: `win11-lan-ready`
    - Click **Clone**  
  - Log in complete the setup wizard
    - Start the VM
      - If you don't want to create a Microsoft account during setup, it's convenient to disable the Internet connect (as simple as powering down the VyOS router for now)
    - Set region and keyboard layout, skip second keyboard layout
    - Name your device: **windows11-lan**
    - Select **Set up for personal use** (feel free to experiment)
    - Windows 11 Pro is forcing "Sign in"
      - This method didn't work in our Lab testing
        - Shift-F10 and enter OOBE\BYPASSNRO
        - It will reboot the system and restart the installation wizard
        - It's supposed to give you the option to not have to create a Microsoft account, but it didn't work in the Labe
      - Instead disconnect from the internet and start over
        - Option 1 - power down the voyos router for a while
        - Option 2 - edit the VM's network device and chedk Disconnect for now; uncheck it later
    - At *Let's connect you to a network*
      - Click **I don't have internet**
    - Click **Continue with limited setup**
    - User: **lab**
    - Password: select a password
    - Create security questions for this account: be creative
    - Privacy: *disable all the settings* and then click **Next**
- Reconnect to the Internet
- Apply Windows Updates (reboots included)
- Enable Remote Desktop (RDP)
  - Start > Settings > System > Remote Desktop
  - Slide to enable and Confirm
- [Install QEMU Guest Agent](Appendix_Install_Guest_Agent_Windows.md)
- Change the hostname to win-11-lan-ready
  - From administrative powershell: `Rename-Computer -NewName win11-lan-ready`
- Shut down the Windows VM
- Clone win11-lan-ready to create more Windows 11 VMs
- Questions to ponder:
  - What are the differences between the two cloning bases we created?
  - Does this affect the Activation required timers?
- Optionally create another VM from each win11-lan and win11-lan-ready and experiment

# Windows 2022 Server
This is a bare-bones server with limited resources. Have seen Server 2019 run on 1GB RAM.

- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **server2022-lan**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Windows 2022 Serer Eval ISO from dropdown*
    - Guest OS:
      - Type: **Microsoft Windows**
      - Version: **11/2022/2025**
  - System tab
    - No TPM or EFI disk requried
  - Disks tab
    - Disk size: **128GB**
    - Bus/Device defaults to IDE; feel free to experiment with this
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 1
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **2048 MB** (2GB)
  - Network tab
    - Bridge: **vmbr1**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > 107 (win11-lan)
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate windows is opened
- You are prompted **Press any key to boot from CD or DVD....**
  - **press any key**
  - if you missed it, stop the VM, start again and try again at the console
- Open the console and follow the Install wizard per usual
  - Confirm Language, formats, and keyboard then Next
  - Click Install now
  - Select the OS to install: Windows Server 2022 Standard Edition Evaluation (Desktop Experience)
    - feel free to experiment
  - Check the box then Next
  - Click Custom: Install Windows only (advanced)
  - Accept the installation on Drive 0
- When the system boots to "Customize settings" and prompts to set the Administrator's password
  - Remove the installation media
    - Back in the main proxmox window, click on the VM, then click hardware
    - Edit the CD/DVD Drive
      - Do not use any media
  - Shift-F10 to open command prompt
  - `shutdown /t 0 /s`
- Clone a new VM from `server2022-lan`
  - Click on the VM server2022-lan (it should still be powered off)
  - Click More > Clone
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - NOTE There is no "Linked Clone" option
    - Name: `server2022-lan-ready`
    - Click **Clone**  
- Power on `server2022-lan-ready`
- After booting, set password for Administrator
- Log in
  - Expand the noVNC menu on the left
  - The first icon "A" is for "extra keys"; click the "Ctrl-Alt-Delete button" at the bottom
  - Yes, allow the server to be discovered by other hosts on the network
- Apply Windows Updates (reboots included)
- Enable RDP
  - Start > Settings > System > Remote Desktop
  - Slide to Enable Remote Desktop then accept the message
- [Install QEMU Guest Agent](Appendix_Install_Guest_Agent_Windows.md)
- Change the hostname to server2022-lan-ready
  - From administrative powershell: `Rename-Computer -NewName server2022-lan-ready`
- Shut down the Windows VM `server2022-lan-ready`
- Clone a new VM from `server2022-lan-ready`
  - We are preparing a Server 2022 image suitable for cloning
  - must perform generalization to remove the security identifier (SID)
  - Click on the VM server2022-lan-ready (it should still be powered off)
  - Click **More** > **Clone**
    - Target node: **proxmox-lab**
    - VM ID: *automatically populated**
    - NOTE There is no "Linked Clone" option
    - Name: `server2022-lan-prep`
    - Click **Clone**  
- Power on `server2022-lan-prep`
  - Open the console to server2022-lan-prep and log in
    - Open an administrative CMD or powershell window
    - `cmd /k %WINDIR%\System32\sysprep\sysprep.exe /oobe /generalize /shutdown`
  - From now on, clone Windows Server VMs from server2022-lan-prep
- Questions to ponder:
  - What are the differences between the three Windows server clone images?
  - Does this affect the 180-day evaluation timer?
  - What are the advantages of each?
- Optionally clone VMs from each and experiment
  - How could you use Templates to quickly roll out a number of Windows servers with the same function or application? (e.g., a web server)

Another NUC Lab (for XCP-ng) has details on
- Converting Windows Server to a Domain Controller
- Configuring a domain file server
- https://github.com/doritoes/NUC-Labs/tree/main/XCP-ng

# Confirm quemu Agents are Running
Verify from proxymox that the agents are running on your VMs
- Log in to proxmox web GUI and find the VM's ID (for example, 102)
- Log in to proxymox CLI and ping the VM's ID
  - `qm agent 102 ping`
- No message means it was successful, "QEMU guest agent is not running" means it is failing
