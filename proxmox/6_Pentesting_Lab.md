# Set Up Pentesting Lab

NOTE At this point you will need Internet access to download content and update some of your systems. This will probably use your regular Lab Internet.

Before doing any "live fire" testing, take one of the following steps:
- Disable/block/prevent traffic from the pentesting network outside of the isolated subnet
- Secure the connection to the Internet using a VPN
- Anonymize the Internet connection using Tor

# Install Kali Linux VM
Kali Linux is a popular distribution for pentesting.
- From the top ribbon click **Create VM**
  - General tab
    - Node: **proxmox-lab**
    - VM ID: *auto populates* (unique ID required for every resource)
    - Name: **kali**
  - OS tab
    - Storage: *select one of the ISO storage units you created*
    - ISO image: *search and/or select the Kali Linux ISO from dropdown*
    - Guest OS:
      - Type: Linux
      - Version: 6x - 2.6 Kernel
  - System tab
    - No changes
  - Disks tab
    - Disk size: **60GB**
    - Check **Discard** because our host uses SSDs
  - CPU tab
    - Sockets: 1
    - Cores: 4
    - Type: default (my Lab is x86-64-v2-AES)
  - Memory tab
    - **4096 MB** (4GB) minimum because we will be using OpenVAS  (Greenbone vulnerability manager)
  - Network tab
    - Bridge: **vmbr2**
  - Confirm tab
    - Check **Start after created**
    - Click **Finish**
- From the left menu navigate to the new VM
  - Datacenter > proxmox-lab > kali
  - Click on the VM in the left menu
- Click the **Console** button along the top of the pane
  - a separate window is opened
- Follow the installation wizard
  - Select **Graphical Install**
  - Select language, location, keyboard layout
  - Hostname: **kali**
  - Domain name: **proxmox.lab**
  - Full name: **kali** (feel free to customize)
  - Username: **kali**
  - Password: *select a password*
  - Select timezone
  - Accept **Guided** partition, **use entire disk and set up LVM**
  - Confirm the disk to be used
  - Accept **All files in one partition** for this Lab
  - Approve making the change, approve the size, approve writing the changes to disk
  - Accept the default desktop and packages (feel free to customize)
  - Wait patiently as packages are copied unpacked and installed
  - Accept installing the GRUB boot loader, and select the device
  - When prompted, eject the installation iso and click Continue to reboot
    - Select the VM > Hardware > Edit CD/DVD Drive > Do not use any media
- Log in
- Update software packages
  - `sudo apt update && sudo apt upgrade -y`
  - To upgrade to the latest Kali version:
    - `sudo apt full-upgrade -y`

# Deploy more VMs
Here are some systems to create on the Pentesting network
- Up-to-Date systems
  - Windows 10/11
    - Optionally, deliberately make it vulnerable
      - https://medium.com/@bmatth21/how-to-setup-windows-10-vm-lab-for-hacking-608592d550f2
      - http://cyberforensic.net/labs/AutoPatch_Removal.html
  - Windows Server 2022
    - Optionally set up a domain, file server, workstations, etc.
  - Ubuntu Desktop or Server
  - Other distros like FreeBSD
- Vulnerable/Out-of-Date systems
  - some downright dangerous with critical unpatched vulnerabilities and should only be added AFTER you secure/isolate the pentesting lab
  - Windows 7 (https://archive.org/details/WindowsCollection)
  - Windows XP ☠️
  - Older versions of Ubuntu (https://old-releases.ubuntu.com/releases/)
    - https://ubuntu.com/security/notices and select a release to see the vulnerabilities
    - OpenSSH is a good example of where to look for vulnerabilities
    - https://www.netspi.com/blog/technical-blog/network-pentesting/linux-hacking-case-studies-part-5-building-a-vulnerable-linux-server/
  - https://www.vulnhub.com/

# Ready for Pentesting
This Lab does not provide complete step-by-step pentesting examples. However, here is a basic sequence of testing you can follow.

## Discovery
### netdiscover
netdiscover as a tool for active and passive ARP reconnaissance. it sends ARP requests and analyzes responses to identify active devices. Can potentially identify the device vendor (OUI lookup)
- `sudo netdiscover`

### nmap
nmap is a powerful network scanner with a robust set of tools and services
scripts. Beyond MAC address, it can identify open and closed ports. This information can be used for service identification and identifying vulnerable services.
- `nmap -sn 192.168.101.0/24`
- `nmap -A 192.168.101.0/24`
- `sudo nmap -O 192.168.101.0/24`

- Linux and SSH
  - `sudo nmap -p 22 -sS 192.168.101.0/24`
  - `nmap -p 22 -sV 192.168.101.0/24`

- Windows machines and SMB
  - nmap scripts (`/usr/share/nmap/scripts`)
    - Win10 often doesn't respond to ping, add -Pn as needed
    - You will discover more things after you create a file share on the target Windows system
      - Use "Optional features" (more Windows features) to enable "SMB 1.0/CIFS server" and "Internet Information Services"
    - `nmap --script smb-system-info.nse <target>`
    - `nmap --script smb-os-discovery.nse <target>`
    - `nmap --script smb2-capabilities.nse <target>`
    - `nmap --script smb-enum-shares.nse <target>`
    - `nmap --script smb-security-mode.nse <target>`

### enum4linux
enum4linux enumerates SMB share information
- `enum4linux - [cheat sheet](https://highon.coffee/blog/enum4linux-cheat-sheet/)
  - `enum4linux 192.168.101.22`
  - Using credentials
    - `enum4linux -u lab -p lab -a 192.168.101.22`

## Finding Vulnerabilities
### Nikto
Nikto is a web server scanner that looks for harmful files and checks for outdated software.
- `nikto -h <target_IP>`
Lots of output, focus on
- Overview
- Server Information
- Look for keywords suspicious, outdated, vulnerable

### OpenVAS
References:
- https://hassen-hannachi.medium.com/installing-openvas-on-kali-linux-a54baeaf806a
- https://greenbone.github.io/docs/latest/22.4/kali/index.html
- https://forums.kali.org/showthread.php?71778-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2022-1
- https://forums.kali.org/showthread.php?150733-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2023-2a&highlight=openvas

- Setup
  - `sudo apt update && sudo apt upgrade -y`
  - `sudo apt install -y --install-recommends gvm`
  - `sudo gvm-setup`
    - Wait patiently for this to complete (it takes a <ins>long time</ins> to download all the data using single-threaded rsync)
    - Note the admin account name and password (it's a long randomly generated password)
    - Reset password to something easier: `sudo gvmd --user=admin --new-password=passwd`
  - Create user kali
    - `sudo runuser -u _gvm -- gvmd --create-user=kali`
    - `sudo runuser -u _gvm -- gvmd --user=kali --new-password=kali`
  - Verify installation: `sudo gvm-check-setup`
    - NOTE This starts gvm (OpenVAS)
- Starting and Stopping
  - OpenVAS uses a LOT of resources, so only start OpenVAS when needed, and stop it when done
    - The Kali menu under `02 - Vulnerability`
      - `gvm start`
      - `gvm stop`
    - Command line
      - `sudo gvm-start`
      - `sudo gvm-stop`
- Logging in
  - Make sure GVM is started
  - https://localhost:9392
  - Log in using the username and password set earlier
    - `kali`/`kali`
- Make sure feeds are loaded before continuing
  - From the menu click **Administration** > **Feed Status**
  - Wait until all the Feed Status show **Current**
  - If you run `top` you will see postgres can only use one CPU, and it's taking a long time
- First Scan
  - After your Feeds are Loaded, try your first scan
  - Scans > Tasks > Magic wand - Task Wizard
  - Enter IP to scan right away
    - First time: accept 127.0.0.1
  - If you get the error "Failed to find config 'daba56c8-73ec-11df-a475-002264764cea'"
    - Make sure the feed status changes crom Update in Progress... to current
    - Make sure you hve 4 vCPUs+ and 4GB+ RAM
- Continue with scans of the rest of your VMs in the pentesting lab
- Review the Results
  - Scans > Reports
  - Scans > Results
  - Scans > Vulnerabilities
- Try adding credentials and scanning again
  - Configuration > Credentials

Various Sync commands
- `sudo runuser -u _gvm -- greenbone-nvt-sync`
- `sudo gvm-feed-update`

Using the results:
- Focus on High and Medium; see software information and potential exploits (CVEs)
- Look for exploitable CVEs and if public available exploits exist

## Attack and exploit tools
- Responder - fake server; does relaying; deals with POP IMAP SMTP SQL queries MLMNR, NBT; recover usernames and passwords
- Metasploit - validate and launch exploits (paid version provides GUI)
- ettercap - ARP poisoning

## Miscellaneous tools
- Searchsploit - enables search database of exploits/archive; see if a system may be vulnerable to a specific exploit
