# Appendix - Ansible Configuring Check Point Lab
This appendix follows the next steps after completing [Appendix - Terraform and XCP-ng](Appendix-Terraform.md). Now that the VMs are created, it's time to prepare them for the next step, configuring and managing using Ansible.

Notes:
- The Linux-based VM templates have the user `ansible` created. SSH with RSA keys still needs to be enabled.

# Build the Environment using Terraform
- `terraform plan`
- `terraform apply -auto-approve`

# Configure Management Workstation
- From XO, click on `manager`
  - Note the network is configured for two interfaces
    - First one: `Pool-wide network associated with eth0`
      - allows downloading and installing software and packages
      - will be disabled (or completely removed) after Branch 1 configuration is complete
    - Second one: `branch1mgt`
- Log in to the console of `manager`
- Optionally, from the app store install "Windows Terminal" by Microsoft
  - this makes it easy to switch between CMD, Powershell, and WSL shells
  - Open Microsoft Store, update it if required
  - Install **Windows Terminal**
  - Open Terminal and note the dropdown to select which terminal(s) you want to open
- Rename the PC to `manager`
  - From administrative powershell
    - `Rename-Computer -NewName manager`
    - `Restart-Computer`
- Install WSL
  - **Start** > **Settings** > **Add an optional feature**
  - Click **More Windows features**
  - Check **Windows Subsystem for Linux**
  - Click **OK**
  - Click **Restart now**
  - Log back in and open a privileged shell
    - `wsl --list`
    - `wsl --list --online`
    - `wsl --install -d Ubuntu-22.04`
      - feel free to customize
      - another window is opened as WSL is initialized
        - Enter the username (i.e., `ansible`) and password to use
        - If you use a username other than `ansible`, please create the `ansible` user and use that for your Ansible work
- Configure Network interfaces
  - **Settings** > **Network & Internet**
  - **Click Ethernet** > **First Interface** (connected)
    - Network profile: **Private**
  - Click **Ethernet** > **Second Interface** (No Internet)
    - IP assigment: Click **Edit**
    - From dropdown select **Manual**
    - Slide to enable **IPv4**
      - We cannot set the IP address without a gateway IP or DNS from this interface!
  - Click **Start** > **Settings** > **Network & Interface** > **Ethernet**
    - Click **Change adapter options**
    - Open the adapter (i.e., **Ethernet 3**) with "Unidentified network"
    - Click **Properties**
    - Double-click **Internet Protocol Version 4** (TCP/IPv4)
    - Change to "Use the following IP address"
      - Use the following IP address:
        - IP address: **192.168.41.100**
        - Subnet mask: **255.255.255.0**
        - Gateway: Leave empty
        - Leave DNS entries empty
        - Click **OK**
      - Click **OK**
    - Click **Close**
- Install additional Windows applications
  - [Chrome browser](https://www.google.com/chrome/)
  - [WinSCP](https://winscp.net/eng/download.php)
- This is a good time to change your display resolution to 1440 x 900 or your resolution of choice
- Install additional WSL packages
  - `sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y`
  - Install Ansible and requirements
    - `sudo apt install -y ansible python3-paramiko python3-pip`
    - `ansible-galaxy collection install community.general vyos.vyos check_point.mgmt check_point.gaia`
    - `python3 -m pip install XenAPI`
  - WARNING Ubuntu 22.04 installs Ansible 2.10 which is an older version. Here is how to install 2.16 (or later)
    - Remove default version
      - `sudo apt remove ansible`
      - `sudo apt --purge autoremove`
    - Set up PPA support
      - `sudo apt install -y software-properties-common`
      - `sudo apt-add-repository ppa:ansible/ansible`
    - Install latest version of Ansible
      - `sudo apt update && sudo apt install -y ansible`
      - `ansible --version`
    - Install the Ansible collections
      - `ansible-galaxy collection install community.general vyos.vyos check_point.mgmt check_point.gaia`
- Generate ssh RSA key for user `ansible`
  - Open WSL terminal (Start > search WSL, or open Windows Terminal and click the dropdown carrot and click Ubuntu)
  - `ssh-keygen -o`
    - <ins>Do not</ins> enter a passphrase
    - Accept all defaults (press enter)
  - The public key you will be using:
    - `cat ~/.ssh/id_rsa.pub`
- Set up basic configuration files for Ansible
  - Create `ansible.cfg` from [ansible.cfg](ansible/ansible.cfg)
  - Create `inventory` from [inventory](ansible/inventory)
    - Note the values are commented out; we will confirm and enable these IPs later in the Lab
    - Under `[router]` you will put the Lab IP address of the router
      - This will be configured in the next step
      - And yes, the simulated Internet IP; the inside interface won't be accessible until later

# Configure VyOS Router
- Open the `vyos` router VM and log in to console
- Configure eth0 interface
  - `configure`
  - `set interfaces ethernet eth0 address dhcp`
  - `set service ssh`
  - `commit`
  - `save`
  - `exit`
  - Get the IP address on eth0
    - `show interfaces ethernet eth0 brief`
- From `manager` VM configure key login in VyOS
  - Log in to VyOS as `ansible`
    - `ssh ansible@<vyos_lab_ip>`
    - accept the key
    - log in with password
  - `configure`
  - `set system login user ansible authentication public-keys home type 'ssh-rsa'`
  - `set system login user ansible authentication public-keys home key '<valueofkey>'`
    - paste in contents of the id_rsa.pub file on manager <ins>without the leading `ssh-rsa`</ins>
  - `commit`
  - `save`
  - `exit`
- Test Ansible access
  - `exit`
  - Retry: `ssh ansible@<vyos_lab_ip>`
    - no longer requies a password
  - Edit the `inventory` files to add the IP address of the router below `[router]`
  - the `inventory` files should have the VyOS "public" IP without the "#" comment character
  - everything else should be "commented out"
  - `ansible all -m ping`
  - You are expecting `SUCCESS` and `"ping": "pong"`
- Configure router using Ansible
  - Create router.yml from [router.yml](ansible/router.yml)
  - `ansible-playbook router.yml`
  - Testing
    - Login in to the VyOS router
    - `show interfaces`
    - Spin up a temporary VM based on template `win10-template` on the **build** network
      - it should be get DHCP information and be able to connect to the Internet

# Configure SMS
Steps:
- Under Advanced, set the network iterface settings to disable TX checksumming
- Log in to console of SMS
  - Username `admin` and the password you selected
- Set IP address information
  - `set interface eth0 ipv4-address 192.168.41.20 mask-length 24`
  - `save config`
- Log in to `manager` and open a WSL shell
  - `ssh ansible@192.168.41.20`
    - you will be in the default home directory `/home/ansible`
- Create new authorized_keys file and add the key
  - `mkdir .ssh`
  - `chmod u=rwx,g=,o= ~/.ssh`
  - `touch ~/.ssh/authorized_keys`
  - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
  - Add the public key from `manager` to the files
    - `cat > ~/.ssh/authorized_keys`
      - paste in the key
      - press Control-D
  - `exit`
  - You can now ssh without a password
    - `ssh 192.168.41.20`
- Test Ansible access
  - Exit back to session on manager
  - update file `inventory`, uncomment to IP of the SMS 192.168.41.20
    - leave the variable intact
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for 192.168.41.20
    - the router should also respond `SUCCESS`
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS)
  - [vars.yml](ansible/vars.yml)
  - [sms.yml](ansible/sms.yml)
  - [sms.j2](ansible/sms.j2)
  - [sms-user.j2](ansible/sms-user.j2)
- Run the playbook to complete the first time wizard (FTW), reboot, and add the user "ansible" to the SMS's managment database
  - `ansible-playbook sms.yml`
    - This takes a long time
    - Uses `config_system` tool to perform FTW
    - Creates user `ansible` using `mgmt_cli`
      - Creating the user directly using the ansible module `add-administrator` isn't working correctly as of this writing
    - Allows all IP addresses to connect to the API in our Lab environment
  - Testing
    - Log in to `sms` console (or ssh)
      - `fwm ver`
      - Should say *Check Point Management Server R81.20*
    - `api status`
- Log in to `sms` Web gui from `manager`
  - https://192.168.41.20
  - Download the SmartConsole R81.20 client using the link "Download Now!"
- Install SmartConsole using the downloaded file
- Launch SmartConsole
  - Username: `cpadmin`
  - Password: *the password from vars.yml (default Checkpoint123!)*
  - Server Name or IP Address: **192.168.41.20**
  - Accept the server identity and click **Proceed**
  - After a short time, the SmartConsole app will prompt you to click **Relaunch Now** to apply the latest updates
    - In Lab testing sometimes a pop-up error appeared after trying to launch while staying logged in
      - "Application has experienced a serious problem and must close immediately"
      - Click **OK** and continue using the application normally
- Update Gaia (if you have proper eval licenses)
  - A valid license is required for downloads and updates (the 15-day trial license does not meet this requriement)
  - SMS updates are best applied manually (whereas firewalls are updated using management API)
    - clish
      - installer check-for-updates
      - installer download [tab]
      - installer install [tab]
    - Web GUI > Upgrades (CPUSE)
- Create objects in the Check Point database related to management
  - Create files on the manager (inventory, playbook)
    - [inventory-api](ansible/inventory-api)
      - Customize to update the credentials as needed
      - Lab testing to move the login credentials to the playbook was not successful in Ansibile 2.10.8
      - Starting Ansible 2.11, use new `include_vars` to include the var.yml and use the credentials from there
    - [management-objects.yml](ansible/management-objects.yml)
  - `ansible-playbook -i inventory-api management-objects.yml`
  - In SmartConsole press Control-E to open the Object explorer
    - Expand Network Objects
    - Note that the new hosts and network appear when you select Networks and/or Hosts 

Note:
- To reset and re-run the FTW on this management server, remove the following files:
  - `/etc/.wizard_accepted`
  - `/etc/.wizard_started`
  - `$FWDIR/conf/ICA.crl`
  - `$FWDIR/conf/InternalCA.*`

References:
- https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/
- https://docs.ansible.com/ansible/latest/collections/check_point/mgmt/cp_mgmt_checkpoint_host_module.html#examples
- https://www.youtube.com/watch?v=fx1KMtuBHWs

# Configure Branch 1
The following steps configure Branch 1
## Configure Branch 1 firewalls
Steps:
- BEFORE you POWER ON the firewalls
  - Turn off TX checksumming on each interface
  - Click Network tab
  - For each interface click the blue gear and click to set TX checksumming **Disabled**
- Power of **firewall1a** and **firewall1b**
- Log in to consoles of **firewall1a** and **firewall1b**
  - Username `admin` and the password you selected
- Set IP address information
  - firewall1a
    - `set interface eth0 ipv4-address 192.168.41.2 mask-length 24`
    - `save config`
  - firewall1b
    - `set interface eth0 ipv4-address 192.168.41.3 mask-length 24`
    - `save config`
- Add `manager`'s RSA keys to each firewall's authorized_keys file
  - Log in to `manager` and open a WSL shell
    - ssh to firewall1a and firewall1b
      - `ssh ansible@192.168.41.2`
      - `ssh ansible@192.168.41.3`
      - you will be in the default home directory `/home/ansible`
  - Create new authorized_keys file and add the key
    - `mkdir .ssh`
    - `chmod u=rwx,g=,o= ~/.ssh`
    - `touch ~/.ssh/authorized_keys`
    - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
    - Add the public key from `manager` to the files
      - `cat > ~/.ssh/authorized_keys`
        - paste in the key
        - press Control-D
    - `exit`
  - You can now ssh without a password
- Test Ansible access
  - Exit back to session on manager
  - update file `inventory`, uncomment the IPs of firewall1a (192.168.41.11) and firewall1b (192.168.41.12)
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for both firewalls
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS)
  - [firewall1a.yml](ansible/firewall1a.yml)
  - [firewall1a.cfg](ansible/firewall1a.cfg)
  - [firewall1b.yml](ansible/firewall1b.yml)
  - [firewall1b.cfg](ansible/firewall1b.cfg)
  - [branch1.j2](ansible/branch1.j2)
- Run the playbooks to complete the first time wizard (FTW) and reboot
  - `ansible-playbook firewall1a.yml`
  - `ansible-playbook firewall1b.yml`
- Test
  - You should still be able to connect to the web GUI from `manager`
  - https://192.168.41.2
  - https://192.168.41.3
- Update Gaia (if you have proper eval licenses)
  - A valid license is required for downloads and updates (the 15-day trial license does not meet this requriement)
  - Firewalls are best updated using the management API
- Create objects in the Check Point database related to Branch 1
  - Create file on `manager`
    - [branch1-objects.yml](ansible/branch1-objects.yml)
  - `ansible-playbook -i inventory-api branch1-objects.yml`
- Create cluster using API
  - https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/content/module/cp_mgmt_simple_cluster/
  - Create file on `manager`
    - [firewall1-cluster.yml](ansible/firewall1-cluster.yml)
  - `ansible-playbook -i inventory-api firewall1-cluster.yml`
- Create new policy using API
  - [branch1-policy.yml](ansible/branch1-policy.yml)
    - 🌱 still working on policy
    - `ansible-playbook -i inventory-api branch1-policy.yml`
- Push policy
  - [push-branch11.yml](ansible/push-branch1.yml)
    - `ansible-playbook -i inventory-api push-branch1.yml`
- 🌱 DHCP helper in DMZ?
- Remove management workstation from the lab network, so solely be on Branch 1 Management
- 🌱 Test

## Configure Domain Controller
- Promote Domain Controller
- Configure Domain
- Configure DHCP

## Configure LAN devices
- workstation
- file server

## Configure DMZ Servers
- Set up NAT and rules
- IIS and Apache servers

## HTTPS Inspection
- HTTPS inspection

# Configure Branch 2
- Initial settings
- FTW
- Gaia config
- Create cluster
- policy
- VPN tunnel bring up
- DHCP helper?????

# Configure Branch 3
- Initial settings
- FTW
- Gaia config
- Create cluster
- policy
- VPN tunnel bring up
- DHCP helper?????
