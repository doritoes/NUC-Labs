# Appendix - Ansible Configuring Check Point Lab
This appendix follows the next steps after completing [Appendix - Terraform and XCP-ng](Appendix-Terraform.md). Now that the VMs are created, it's time to prepare them for the next step, configuring and managing using Ansible.

Notes:
- The Linux-based VM templates have the user `ansible` created. SSH with RSA keys still needs to be enabled.

# Build the Environment using Terraform
- `terraform plan`
- `terraform apply -auto-approve`

# Configure Management Workstation
- From XO, click on `manager`
  - Note the network is configured for two interfaces
    - First one: `Pool-wide network associated with eth0`
      - allows downloading and installing software and packages
      - will be disabled (or completely removed) after Branch 1 configuration is complete
    - Second one: `branch1mgt`
- Log in to the console of `manager`
- Optionally, from the app store install "Windows Terminal" by Microsoft
  - this makes it easy to switch between CMD, Powershell, and WSL shells
  - Open Microsoft Store, update it if required
  - Install **Windows Terminal**
  - Open Terminal and note the dropdown to select which terminal(s) you want to open
- Rename the PC to `manager`
  - From administrative powershell
    - `Rename-Computer -NewName manager`
    - `Restart-Computer`
- Install WSL
  - Add optional feature Windows Subsystem for Linux (WSL)
    - NOTE In Lab testing, skipping this step caused problems
    - Click **Start** > type "**Add an optional feature**", click it
    - Scroll to bottom, click **More Windows features**
    - <ins>Check</ins> **Windows Subsystem for Linux** and click **OK**
    - Click **Restart now** when prompted
  - Log back in and open a privileged shell
    - `wsl --list`
    - `wsl --list --online`
    - `wsl --install -d Ubuntu-22.04`
      - feel free to customize
      - A new WSL window is opened and you are promped set the username and password
        - Username: `ansible`
        - NOTE if it sticks at *Installing, this may take a few minutes...*, <ins>press Control-C and it will continue</ins> (might take a few presses), prompting you to set the username and password
- Configure Network interfaces
  - **Settings** > **Network & Internet**
  - **Click Ethernet** > **First Interface** (connected)
    - Network profile: **Private**
  - Click **Ethernet** > **Second Interface** (No Internet)
    - IP assigment: Click **Edit**
    - From dropdown select **Manual**
    - Slide to enable **IPv4**
      - We cannot set the IP address without a gateway IP or DNS from this interface!
  - Click **Start** > **Settings** > **Network & Interface** > **Ethernet**
    - Click **Change adapter options**
    - Open the adapter (i.e., **Ethernet 3**) with "Unidentified network"
    - Click **Properties**
    - Double-click **Internet Protocol Version 4** (TCP/IPv4)
    - Change to "Use the following IP address"
      - Use the following IP address:
        - IP address: **192.168.41.100**
        - Subnet mask: **255.255.255.0**
        - Gateway: Leave empty
        - Leave DNS entries empty
        - Click **OK**
      - Click **OK**
    - Click **Close**
- Install additional Windows applications
  - [Chrome browser](https://www.google.com/chrome/)
  - [WinSCP](https://winscp.net/eng/download.php)
- This is a good time to change your display resolution to 1440 x 900 or your resolution of choice
- Install additional WSL packages
  - `sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y`
  - `sudo apt install -y python3-paramiko python3-pip`
    - or `sudo apt install -y software-properties-common python3-paramiko python3-pip`
  - Install Ansible
    - Option 1 - recommended - Ansbile 2.17 (or later)
      - `sudo apt-add-repository ppa:ansible/ansible`
      - `sudo apt update && sudo apt install -y ansible`
      - `ansible --version`
      - Normally installing with ppa method is discouraged; this is is easiest way to get current ansible for automation
    - Option 2 - Ubuntu 22.04 old Ansible 2.10
      - `sudo apt install -y ansible`
      - `ansible --version`
  - Install ansible collections
    - `ansible-galaxy collection install community.general vyos.vyos check_point.mgmt check_point.gaia`
    - `ansible-galaxy collection install check_point.mgmt --force`
  - Install XenAPI python package
    - `python3 -m pip install XenAPI`
  - You might use Git to clone the repo to have the files locally
    - `sudo apt install -y git`
    - `git clone https:/github.com/doritoes/NUC-Labs`
- Generate ssh RSA key for user `ansible`
  - Open WSL terminal (Start > search WSL, or open Windows Terminal and click the dropdown carrot and click Ubuntu)
  - `ssh-keygen -o`
    - <ins>Do not</ins> enter a passphrase
    - Accept all defaults (press enter)
  - The public key you will be using:
    - `cat ~/.ssh/id_rsa.pub`
- Set up basic configuration files for Ansible
  - Create `ansible.cfg` from [ansible.cfg](ansible/ansible.cfg)
  - Create `inventory` from [inventory](ansible/inventory)
    - Note the values are commented out; we will confirm and enable these IPs later in the Lab
    - Under `[router]` you will put the Lab IP address of the router
      - This will be configured in the next step
      - And yes, the simulated Internet IP; the inside interface won't be accessible until later

# Configure VyOS Router
- Open the `vyos` router VM and log in to console
- Configure eth0 interface
  - `configure`
  - `set interfaces ethernet eth0 address dhcp`
  - `set service ssh`
  - `commit`
  - `save`
  - `exit`
  - Get the IP address on eth0
    - `show interfaces ethernet eth0 brief`
- From `manager` VM configure key login in VyOS
  - Log in to VyOS as `ansible`
    - `ssh ansible@<vyos_lab_ip>`
    - accept the key
    - log in with password
  - `configure`
  - `set system login user ansible authentication public-keys lab type 'ssh-rsa'`
  - `set system login user ansible authentication public-keys lab key '<valueofkey>'`
    - paste in contents of the id_rsa.pub file on manager <ins>without the leading `ssh-rsa`</ins>
  - `commit`
  - `save`
  - `exit`
- Test Ansible access
  - `exit`
  - Retry: `ssh ansible@<vyos_lab_ip>`
    - no longer requies a password
  - Edit the `inventory` files to add the IP address of the router below `[router]`
  - the `inventory` files should have the VyOS "public" IP without the "#" comment character
  - everything else should be "commented out"
  - `ansible all -m ping`
  - You are expecting `SUCCESS` and `"ping": "pong"`
- Configure router using Ansible
  - Create router.yml from [router.yml](ansible/router.yml)
  - `ansible-playbook router.yml`
  - Testing
    - Login in to the VyOS router
    - `show interfaces`
    - Spin up a temporary VM based on template `win10-template` on the **build** network
      - it should be get DHCP information and be able to connect to the Internet

# Configure SMS
Steps:
- In XO, select the VM `SMS`
- Under Network tab, set the network interface settings (blue gear icon) and them disable TX checksumming
- Log in to console of SMS
  - Username `admin` and the password you selected
- Set IP address information
  - `set interface eth0 ipv4-address 192.168.41.20 mask-length 24`
  - `save config`
- Log in to `manager` and open a WSL shell
  - `ssh ansible@192.168.41.20`
    - you will be in the default home directory `/home/ansible`
- Create new authorized_keys file and add the key
  - `mkdir .ssh`
  - `chmod u=rwx,g=,o= ~/.ssh`
  - `touch ~/.ssh/authorized_keys`
  - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
  - Add the public key from `manager` to the files
    - `cat > ~/.ssh/authorized_keys`
      - paste in the key
      - press Control-D
  - `exit`
  - You can now ssh without a password
    - `ssh 192.168.41.20`
- Test Ansible access
  - Exit back to session on manager
  - update file `inventory`, uncomment to IP of the SMS 192.168.41.20
    - leave the variable intact
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for 192.168.41.20
    - the router should also respond `SUCCESS`
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS)
  - [vars.yml](ansible/vars.yml)
  - [sms.yml](ansible/sms.yml)
  - [sms.j2](ansible/sms.j2)
  - [sms-user.j2](ansible/sms-user.j2)
- Run the playbook to complete the first time wizard (FTW), reboot, and add the user "ansible" to the SMS's managment database
  - `ansible-playbook sms.yml`
    - This takes a long time
    - Uses `config_system` tool to perform FTW
    - Creates user `ansible` using `mgmt_cli`
      - Creating the user directly using the ansible module `add-administrator` isn't working correctly as of this writing
    - Allows all IP addresses to connect to the API in our Lab environment
  - Testing
    - Log in to `sms` console (or ssh)
      - `fwm ver`
      - Should say *Check Point Management Server R81.20*
    - `api status`
- Log in to `sms` Web gui from `manager`
  - https://192.168.41.20
  - Download the SmartConsole R81.20 client using the link "Download Now!"
- Install SmartConsole using the downloaded file
- Launch SmartConsole
  - Username: **cpadmin**
  - Password: *the password from vars.yml (default Checkpoint123!)*
  - Server Name or IP Address: **192.168.41.20**
  - Accept the server identity and click **Proceed**
  - After a short time, the SmartConsole app will prompt you to click **Relaunch Now** to apply the latest updates
    - In Lab testing sometimes a pop-up error appeared after trying to launch while staying logged in
      - "Application has experienced a serious problem and must close immediately"
      - Click **OK** and continue using the application normally
- Update Gaia (if you have proper eval licenses)
  - Wait until the Branch 1 firewalls are configured and providing Internet access
  - A valid license is required for downloads and updates (the 15-day trial license does not meet this requriement); however once Internet access is working, you can use CPUSE to apply jumbo hotfixes
  - SMS updates are best applied manually (whereas firewalls are updated using management API)
    - clish
      - installer check-for-updates
      - installer download [tab]
      - installer install [tab]
    - Web GUI > Upgrades (CPUSE)
- Create objects in the Check Point database related to management
  - Create files on the manager (inventory, playbook)
    - [inventory-api](ansible/inventory-api)
      - Customize to update the credentials as needed
      - Lab testing to move the login credentials to the playbook was not successful in Ansibile 2.10.8
      - Starting Ansible 2.11, use new `include_vars` to include the var.yml and use the credentials from there
    - [management-objects.yml](ansible/management-objects.yml)
  - `ansible-playbook -i inventory-api management-objects.yml`
  - In SmartConsole press Control-E to open the Object explorer
    - Expand Network Objects
    - Note that the new hosts and network appear when you select Networks and/or Hosts 

Note:
- To reset and re-run the FTW on this management server, remove the following files:
  - `/etc/.wizard_accepted`
  - `/etc/.wizard_started`
  - `$FWDIR/conf/ICA.crl`
  - `$FWDIR/conf/InternalCA.*`

References:
- https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/
- https://docs.ansible.com/ansible/latest/collections/check_point/mgmt/cp_mgmt_checkpoint_host_module.html#examples
- https://www.youtube.com/watch?v=fx1KMtuBHWs

# Configure Branch 1
The following steps configure Branch 1
## Configure Branch 1 firewalls
Steps:
- BEFORE you POWER ON the firewalls **firewall1a** and **firewall1b**
  - Turn off TX checksumming on each interface
  - Click Network tab
  - For each interface click the blue gear and click to set TX checksumming **Disabled**
- Power on **firewall1a** and **firewall1b**
- Log in to consoles of **firewall1a** and **firewall1b**
  - Username `admin` and the password you selected
- Set IP address information
  - firewall1a
    - `set interface eth0 ipv4-address 192.168.41.2 mask-length 24`
    - `save config`
  - firewall1b
    - `set interface eth0 ipv4-address 192.168.41.3 mask-length 24`
    - `save config`
- Add `manager`'s RSA keys to each firewall's authorized_keys file
  - Log in to `manager` and open a WSL shell
    - ssh to firewall1a and firewall1b
      - `ssh ansible@192.168.41.2`
      - `ssh ansible@192.168.41.3`
      - you will be in the default home directory `/home/ansible`
  - Create new authorized_keys file and add the key
    - `mkdir .ssh`
    - `chmod u=rwx,g=,o= ~/.ssh`
    - `touch ~/.ssh/authorized_keys`
    - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
    - Add the public key from `manager` to the files
      - `cat > ~/.ssh/authorized_keys`
        - paste in the key
        - press Control-D
    - `exit`
  - You can now ssh without a password
- Test Ansible access
  - Exit back to session on `manager`
  - update file `inventory`, uncomment the IPs of firewall1a (192.168.41.11) and firewall1b (192.168.41.12)
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for both firewalls
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS)
  - [firewall1a.yml](ansible/firewall1a.yml)
  - [firewall1a.cfg](ansible/firewall1a.cfg)
  - [firewall1b.yml](ansible/firewall1b.yml)
  - [firewall1b.cfg](ansible/firewall1b.cfg)
  - [branch1.j2](ansible/branch1.j2)
- Run the playbooks to complete the first time wizard (FTW) and reboot
  - `ansible-playbook firewall1a.yml`
  - `ansible-playbook firewall1b.yml`
- Test
  - You should still be able to connect to the web GUI from `manager`
  - https://192.168.41.2
  - https://192.168.41.3
- Update Gaia (if you have proper eval licenses)
  - A valid license is required for downloads and updates (the 15-day trial license does not meet this requriement)
  - Firewalls are best updated using the management API
- Create objects in the Check Point database related to Branch 1
  - Create file on `manager`
    - [branch1-objects.yml](ansible/branch1-objects.yml)
  - `ansible-playbook -i inventory-api branch1-objects.yml`
- Create cluster using API
  - https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/content/module/cp_mgmt_simple_cluster/
  - Create file on `manager`
    - [firewall1-cluster.yml](ansible/firewall1-cluster.yml)
  - `ansible-playbook -i inventory-api firewall1-cluster.yml`
- Create new policy using API
  - [branch1-policy.yml](ansible/branch1-policy.yml)
    - `ansible-playbook -i inventory-api branch1-policy.yml`
- Push policy
  - [branch1-push.yml](ansible/branch1-push.yml)
    - `ansible-playbook -i inventory-api branch1-push.yml`
- At this point you should be able to install a JHF on the SMS and on the firewalls
  - SSH or console to each device (sms, firewall1a, firewall1b)
  - `clish`
  - `installer check-for-updates`
  - `installer download-and-install [tab]`
  - select the applicable JHF hotfix bundle by number
  - Approve the reboot

## Remove management workstation from the Lab network
Disable lab-connected interface on `manager`, leaving sole connection via Branch 1 Management network
- Click **Start** > **Settings** > **Network & Internet** > **Ethernet**
- Click **Change adapter options**
- Configure Ethernet 3 interface
  - Double-click the Ethernet 3 interface, which is connected to the Management network
  - Properties > Internet Protocol Version 4 (TCP/IP/IPv4)
  - Configure default gateway: **192.168.41.1**
  - Enter DNS servers
    - 8.8.8.8
    - 8.8.4.4
  - Click **OK** > **OK** > **Close**
- Disable Ethernet 2 interface
  - Right-click Ethernet 2
  - Click Disable
- Test Internet connectivity, etc. to confirm it is still working

## Configure Domain Controller
- Open console for DC-1
- Complete initial setup and set administrator password
- Log in for the first time
- Rename server
  - Open administrative powershell
  - `Rename-Computer -NewName dc-1`
  - `Restart-Computer`
- Network configuration
  - Log back in
  - Open administrative powershell
  - Set the static IP address and point DNS settings to itself (it's going to be a domain controller).
    - `New-NetIPAddress -IPAddress 10.0.1.10 -DefaultGateway 10.0.1.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
    - **Yes** allow PC to be discoverable
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
- Optionally increase the display resolution (e.g., 1440 x 900)
- Promote DC-1 from server to Domain Controller
  - `Install-WindowsFeature -Name AD-Domain-Services -IncludeManagementTools`
  - `Install-ADDSForest -DomainName xcpng.lab -DomainNetBIOSName AD -InstallDNS`
    - Select a password for SafeModeAdministratorPassword (aka DSRM = Directory Services Restore Mode)
  - Confirm configuring server as Domain Controller and rebooting
  - Wait as the settings are applied and the server is rebooted
  - Wait some more as "Applying Computer Settings" gets the domain controller ready
- Configure Sites and Services Subnets and DNS
  - branch1-site.ps1 ([branch1-site.ps1](powershell/branch1-site.ps1))
  - `powershell -ExecutionPolicy Bypass branch1-site.ps1`
  - 🌱create more DNS entries
  - test using nslookup
    - nslookup google.com
    - nslookup firewall1-lan
    - nslookup firewall1-lan.xcpng.lab
    - nslookup 10.0.1.1
    - nslookup dc-1
    - nslookup 10.0.1.10 (will not resolve yet)
- Configure DC-1 as DHCP server
  - branch1-dhcp.ps1 ([branch1-dhcp.ps1](powershell/branch1-dhcp.ps1))
  - `powershell -ExecutionPolicy Bypass branch1-dhcp.ps1`
  - test
    - `Get-DhcpServerInDC`
    - spin up a test workstation on branch1 subnet
      - confirm it receives an IP address via DHCP
      - test Internet access
  - NOTE Server manager will complain: "Configuration required for DHCP Server at DC-1"
    - You can click on the link to create security groups for delegation of DHCP Server Administration and also authorize DHCP server on target computer. Or find a way to do it with powershell.
- Configure AD users, groups, roles, and permissions
  - copy domain-users.csv [domain-users.csv](powershell/domain-users.csv) to C:\domain-users.csv
  - copy domain-users-groups.ps1 [domain-users-groups.ps1](powershell/domain-users-groups.ps1)
  - `powershell -ExecutionPolicy Bypass C:\domain-users-groups.ps1`
- Configure to use external time server
  - `net stop w32time`
  - `w32tm /config /syncfromflags:manual /manualpeerlist:"time.windows.com"`
  - `w32tm /config /reliable:yes`
  - `net start w32time`
  - `w32tm /query /configuration`
  - `w32tm /resync`
  - `w32tm /query /status`
- Test logging in to the domain controller as `AD\Juliette.Larocco2` and the password from [domain-users.csv](powershell/domain-users.csv)
  - Juliette.Larocco2@xcpng.lab

## Configure LAN devices
- Configure workstation **branch1-1**
  - Log in for the first time at the console
  - Rename workstation
    - Open administrative powershell
    - `Rename-Computer -NewName branch1-1`
    - `Restart-Computer`
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
  - Testing
    - Log in as Other user > juliette.larocco
      - Note the first time experience for the domain user
      - Try Remote desktop connection to DC-1
        - juliette.larocco fails "Logon failure: the user has not been granted the requested logon type at this computer."
        - juliette.larocco2 fails if "Administrator" is still logged in on DC-1
- Configure file server **file-1**
  - Complete initial setup and set administrator password
  - Log in for the first time at the console
  - **Yes** allow your PC to be discoverable by other PCs and devices on this network
  - Rename server
    - Open administrative powershell
    - `Rename-Computer -NewName file-1`
    - `Restart-Computer`
  - Network configuration
    - Open administrative powershell
    - Set the static IP address and point DNS settings to the domain controller/DNS server
      - `New-NetIPAddress -IPAddress 10.0.1.11 -DefaultGateway 10.0.1.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
    - Try testing nslookup to see what resolves (IPs, FQDN)
  - Install file server feature
    - `Install-WindowsFeature -Name FS-FileServer`
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
  - Set up share drive and file shares
    - Log in as AD\juliette.larocco2
    - Click **Start** > **Create and format hard disk partitions**
      - You will be prompted to initialize the disk (Disk 1)
      - Accept GPT (GUID Partition Table)
      - Click OK
      - Right-click Disk 1 and then click **New Simple Volume**
      - Assign letter E:
      - Follow the wizard and set the volume label to **NETDRIVE**
    - copy file-shares.ps1 [file-shares.ps1](powershell/file-shares.ps1)
    - `powershell -ExecutionPolicy Bypass file-shares.ps1`
      - NOTE there are no users in OU=Finance,OU=Corp,DC=xcpng,DC=lab in the provided user CSV file; this causes an error when running the script, but the rest is successfully configured
  - Testing
    - test access from `branch1-1` to the shared folders by different domain users
- Configure SQL server **sql-1**
  - Complete initial setup and set administrator password
  - Log in for the first time at the console
  - **Yes** allow your PC to be discoverable by other PCs and devices on this network
  - Rename server
    - Open administrative powershell
    - `Rename-Computer -NewName sql-1`
    - `Restart-Computer`
  - Network configuration
    - Open administrative powershell
    - Set the static IP address and point DNS settings to the domain controller/DNS server
      - `New-NetIPAddress -IPAddress 10.0.1.12 -DefaultGateway 10.0.1.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
    - Try testing nslookup to see what resolves (IPs, FQDN)
  - Set up data drive
    - Click **Start** > **Create and format hard disk partitions**
      - You will be prompted to initialize the disk (Disk 1)
      - Accept GPT (GUID Partition Table)
      - Click OK
      - Right-click Disk 1 and then click **New Simple Volume**
      - Assign letter E:
      - Follow the wizard and set the volume label to **SQL**
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
  - Install MS SQL server ([more information](https://learn.microsoft.com/en-us/sql/database-engine/install-windows/install-sql-server?view=sql-server-ver16))
    - Log in as AD\juliette.larocco2
    - Download SQL Server Express: https://www.microsoft.com/en-us/sql-server/sql-server-downloads
      - file name looks like: `SQL2022-SSEI-Expr.exe`
    - Run the installer
      - Click **Basic**
      - Click **Install SSMS**
        - From the web page that opens, download and install SQL Server Management Studio (SSMS)
      - Back in the SQL Express istaller, click **Connect Now** to test (type `exit` to close the prompt)
      - Click **Close** and confirm
  - Test
    - Launch SQL Server Management Studio (SSMS)
      - Check **Trust server certificate**
      - Click **Connect**
    - For a production environment, use proper authentication
- Configure Check Point Identity Collectror server **idc-1**
  - Complete initial setup and set administrator password
  - Log in for the first time at the console
  - **Yes** allow your PC to be discoverable by other PCs and devices on this network
  - Rename server
    - Open administrative powershell
    - `Rename-Computer -NewName idc-1`
    - `Restart-Computer`
  - Network configuration
    - Open administrative powershell
    - Set the static IP address and point DNS settings to the domain controller/DNS server
      - `New-NetIPAddress -IPAddress 10.0.1.14 -DefaultGateway 10.0.1.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
    - Try testing nslookup to see what resolves (IPs, FQDN)
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
  - Set up Domain Controller for IDC
    - Disable the Windows Firewall on DC-1
      - In extensive testing, the Windows Firewall on a domain controller prevents the IDC from connecting
      - The reliable way to get IDC to connect (especially in this Lab environment) is to disable the firewall on the domain controller
      - Disable: `Set-NetFirewallProfile -Profile Domain -Enabled False`
      - Re-enable: `Set-NetFirewallProfile -Profile Domain -Enabled True`
    - copy idc-user.ps1 [idc-user.ps1](powershell/idc-user.ps1)
      - `powershell -ExecutionPolicy bypass idc-user.ps1`
  - Install Check Point Identity Collector for Windows
    - Download
      - https://support.checkpoint.com/results/sk/sk134312
      - https://support.checkpoint.com/results/download/74206
      - NOTE: Login required; "Missing software subscription to download this file."
        - Not sure if setting up up a proper eval license will take care of this
      - Try this link: https://192.168.101.1/_IA_IDC/download_CPIdentityCollector.msi
      - Also look for the file on the SMS and gateways
      - Or try enabling Identity Awareness and the Identity Collector. A download link will be shown right in SmartConsole.
      - In lab testing this link was 404 until we had a working policy, then it worked
    - Install the Identity Collector
    - Allow Identity Collector in the Windows Firewall on IDC-1
      - Click **Start** > type **Windows Defender Firewall**
      - Click **Allow an app or feature through Windows Defender Firewall**
      - Click **Allow another app**
      - Browse to C:\Program Files (x86)\CheckPoint\Identity Collector\cpidc.exe
      - Repeat for ipidcgui.exe
      - The apps should be allowed for the Domain profile
      - Click OK
    - Configure Identity Collector
      - Launch the app
      - Ribbon menu > Domains
        - Click icon for New domain
          - Name: xcpng.lab
          - Username: adquery
          - Password: YourStrongPassword123!
          - This is an account with log reader permissions on DC-1
          - Click OK
        - Edit the new domain xcpng.lab, and click Test
          - Credentials test
            - IP address: 10.0.1.10 or DC-1
            - Click Test
            - Failure message: Unable to connect; please check connectivity with server and server firewall configuration
              - Fix: Disable the Windows Firewall on the domain controller
            - You can't log in to DC-1 as adquery, but you can log in to branch1-1 to confirm the account works
      - Left menu > Identity Sources
        - New > AD > Add manually
          - Name: DC-1
          - Domain: xcpng.lab
          - Host name / IP address: DC-1 or 10.0.1.10
          - Site: Corp
          - Click Test
          - Failure message: Unable to connect; please check connectivity with server and server firewall configuration. If NTLM authentication restricted, the host name must be used
          - Click OK
      - Ribbon menu > Query Pools
        - New
          - Corp AD
          - Select all Identity Sources
          - Click OK and then click OK
      - Ribbon menu > Filters
        - Add a New filter
          - Name: Prod
          - add list of subnets the clients are on
            - Enter Network 10.0.1.0/24 and comment Branch 1 LAN
            - Click "+" to add it
            - Click OK
      - Left menu > Gateways
        - Add new Gateway
          - Name: firewall1
          - IP Address: 10.0.1.1
          - Shared secret: Checkpoint123!
          - Query pool: Corp AD
          - Filter: Prod
          - Click OK
        - Edit the new gateway and click Test
          - Will fail until the cluster is configured (see below)
      - Left menu > Settings
        - No changes required

## Update management workstation to join the domain
- Log in to `manager`
- Confirm Network profile is **Private**
- Edit IP settings to set DNS
  - Preferred DNS: 10.0.1.10
  - Alternate DNS: *blank*
- Join to domain
  - Open administrative powershell
  - `Add-Computer -DomainName xcpng.lab -restart`
    - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
    - Password: the password you set

## Configure DMZ Servers
- Configure Apache web server **dmz-apache**
  - Configure Static IP address
    - `sudo vi /etc/netplan/01-netcfg.yaml`

```
network:
  version: 2
  ethernets:
    eth0:
      dhcp4: no
      addresses:
        - 192.168.31.11/24
      routes:
        - to: 0.0.0.0/0
          via: 192.168.31.1
      nameservers:
        addresses:
          - 10.0.1.10
```

    - `sudo chmod 600 /etc/netplan/01-netcfg.yaml`
    - `sudo netplan apply`
  - Give permissions to user ansible
    - `echo "ansible ALL=(ALL:ALL) NOPASSWD: ALL" | sudo tee "/etc/sudoers.d/dont-prompt-ansible-for-sudo-password"`
  - set up ssh key auth
    - from `manager`
      - `ssh-copy-id 192.168.31.11`
  - Update file `inventory`
    - uncomment dmzserver 192.168.31.11
    - test: `ansible all -m ping`
  - Update hostname and install packages
    - [php.conf](ansible/php.conf)
    - [ssl.conf.j2](ansible/ssl.conf.j2)
    - [dmz-apache.yml](ansible/dmz-apache.yml)
    - `ansible-playbook dmz-apache.yml`
  - Testing
      - From branch1-1:
        - https://192.168.31.11
        - https://192.168.101.6
      - From manager: http://192.168.31.11
      - From a test machine on build network: http://192.168.101.6
- Configure IIS web server **dmz-iis**
  - Complete initial setup and set administrator password
  - Log in for the first time at the console
  - **Yes** allow your PC to be discoverable by other PCs and devices on this network
  - Rename server
    - Open administrative powershell
    - `Rename-Computer -NewName dmz-iis`
    - `Restart-Computer`
  - Network configuration
    - Log back in
    - Open administrative powershell
    - Set the static IP address and point DNS settings to the domain controller/DNS server
      - `New-NetIPAddress -IPAddress 192.168.31.10 -DefaultGateway 192.168.31.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
      - **Yes** allow your PC to be discoverable by other PCs and devices on this network
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
  - Install IIS
    - Open administrative powershell
    - `Install-WindowsFeature Web-Server -IncludeManagementTools`
    - Test:
      - From dmz-iis: http://localhost
      - From branch1-1:
        - http://dmz-iis
        - http://192.168.31.10
        - http://192.168.101.5
      - From manager: http://192.168.31.10
      - From a test machine on build network: http://192.168.101.5
    - You may want to test IIS by using asp.net hello world https://www.guru99.com/asp-net-first-program.html

## HTTPS Inspection
- Enable application control and url filtering blands, and create outbound https inspection certificate
  - branch1-https.yml [branch1-https.yml](ansible/branch1-https.yml)
  - `ansible-playbook -i inventory-api branch1-https.yml`
- Non-ansible/manual solutions here since ansible check_point.mgmt doesn't support all the commands until R82
  - creating https rules, etc not supported until R82
  - some outbound certificate commands function differently pre-R82
  - `enable-https-inspection` will be added in the next version
- Export the certificate using SmartConsole gui
  - Open the cluster `firewall1`
  - Click on HTTPS Ispection
  - Step one should show completed. If you created with the playbook but it doesn't show in the GUI, you can try to create it from the GUI. However, this did not work on Lab testing.
  - Step two > click **Export certificate**
    - Name it **outbound**
- Step 3 check **Enable HTTPS inspection**
- Click and Publish
- WARNING if you push policy now, your will get https warnings/errors in your browser. Let's set up the trusted Root CA first
- Distribute the https inspection certificate using GPO on DC-1
  - copy the .cer file to DC-1 at `c:\certificate.cer`
  - create the GPO  
    - `$gpoName = "Distribute Root CA Certficate"`
    - `$domainDN = "DC=xcpng,DC=lab"`
    - `New-GPO -Name $gpoName | New-GPLink -Target $domainDN`
  - Open Group Policy Management Console (GPMC)
    - Start > Group Policy Management
    - Forest: xcpng.lab
    - Domain: xcpng.lab
    - OU: Corp
    - Right-click Distribute Root CA Certication from the tree, then click Edit
    - In the console tree, open Computer Configuration\Policies\Windows Settings\Security Settings\Public Key Policies
    - Right-click Trusted Root Certification Authorities, and then click Import
      - Import `c:\certificate.cer`
  - Update Lab_Policy to enable https inspection
    - SECURITY POLICIES > HTTPS Inspection > Policy
    - Change the default rule **Track** value to **Log**
  - Add more https bypass rules manually
    - Not possible with API in R81.20, but available on R82 API
    - First rule
      - Name: Exceptions for recommended imported services
      - Source:
        - *Any
      - Destination:
        - Import > Updatable Objects >  **HTTPS services - recommended bypass**
      - Services:
        - HTTPS default services
      - Action:
        - Bypass
      - Track: Log
    - Second rule
      - Name: Exceptions for categories
      - Source:
        - *Any
      - Destination:
        - Internet
      - Services:
        - HTTPS default services
      - Category/Custom Application:
        - Financial Services
        - Health
      - Action:
        - Bypass
      - Track: Log
    - Third rule (important to allow SMS to download Updatable objects)
      - Name: Bypass inspection
      - Sources:
        - dmz-apache
        - sms
      - Destination:
        - Internet
      - Services:
        - HTTPS default services
      - Action:
        - Bypass
      - Track: Log
    - Pulish and Install the policy

## Import the User Check Certificate
In this step we will import the Check Point ICA certificate and also distribute that using group policy
- From branch1-1 or manager browse to https://192.168.101.1
  - You will receive an untrusted certificate message
  - View the certificate Details
  - Note the Certificate Hierarchy similar to the following
    - O=sms.xcpng.labx3fd5d
      - firewall1 VPN certificate
  - Click on the root "O=sms.xcpng.labx3fd5d"
  - Export/Copy to File
  - Save as type: `DER Encoded Binary X.509 (*.cer)`
  - Name as you wish
- Copy the file to DC-1 (e.g., copy to \\file-1\it\ and access it from there)
- Import the certificate to the GPO for trusted certificates
  - Open Group Policy Management Console (GPMC)
    - Start > Group Policy Management
    - Forest: xcpng.lab
    - Domain: xcpng.lab
    - OU: Distribute Root CA Certication
    - Right click the OU from the tree, and click Edit
    - In the console tree, open Computer Configuration\Policies\Windows Settings\Security Settings\Public Key Policies
    - Right-click Trusted Root Certification Authorities, and then click Import
      - By default the certificate you exported is a .der file; select all file types to see the certificate you downloaded
      - Import the file
- You can now view User Check pages correctly
  - `gpupdate /force` will trigger an update
  - closing/re-opening the browser can solve cacheing issues
  - logging out and back in may also help

## Change website categorization to Hold mode
By default URl categorization occurs in the background. First attempts to a previously unkown URL will cucceed until Check Point ThreatCloud decides it should be blocked. For this lab we will configure it to hold (block until the categorization is complete.
- Log in to SmartConsole
- MANAGE & SETTINGS > Blades > Application Control & URL Filtering > Advanced Settings
- Click Check Point online web service
- Change Website categorization mode to **Hold**
- Click OK, publish, and install policy

## Add Application Control layer
🌱 These changes can likely be done using Ansible and the API. Need to test.
- Open the Access Policy and find the section **General Internet access**
- Find the rule **General Internet access**
- Change action from **Accept** to **Inline Layer > New Layer**
  - Name: **Internet Control**
  - Blades:
    - Firewall (checked)
    - Applications & URL Filtering (checked)
  - Advanced > Implicit Cleanup Action: **Allow**
  - Confirm action is Accept and is set to Log
- Rename the cleanup rule **Allow remaining traffic**
- Add these sub rules above that
  - Subrule 1
    - Name: Block bad sites
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Hacking
      - Pornography
      - Phishing
      - Weapons
      - Critical Risk
      - High Risk
    - Action: **Drop > Blocked Message - Access Control**
    - Track: Log > Accounting
  - Subrule 2
    - Name: Allow general categories
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Medium Risk
      - Low Risk
      - Very Low Risk
    - Action: Accept
    - Track: Log > Accounting
  - Subrule 3
    - Name: Unknown risk
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Uncategorized
      - Unknown Risk
    - Action:
      - Inform
        - Access Approval
        - Once a day
        - Per applications
    - Track: Log > Accounting
- Publish and install Policy
  - This will enable https inspection!
- Test from branch1-1
  - Run `gpupdate /force` at a shell to trigger an immediate group policy update (by default periodic refresh every 90 minutes with a randomized offset of up to 30 minutes)
  - Browse to an internet site like https://github.com and examine the https certificate
    - Edge browser: click the lock next to the URL > Connection is secure
      - Click the Cerificifate icon
      - If https inspection is working, the Issued By will new reflect xcpng.lab
      - Examine logs
  - If the traffic is inspected and intercepted but not trusted by the browser
    - Logging out and back in may also help
    - Confirm the certificate is installed
      - Start > Internet Options > Content
      - Click Certificates and select the Trusted Root Certification Authorities tab
  - If the traffic not intercepted at all
    - add a rule to the HTTPS policy, publish and push, then try again

## Identify Awareness and access roles
The older "AD Query" method is deprecated (see Microsoft vulnerability CVE-2021-26414 and sk176148), and the recommended method is to implement Identity Awareness by deploying **Identity Collector**. See sk108235.

A good alternative for Lab testing is using **Browser-Based Authentication**. The book **Check Point Firewall Administration R81.10+** by Vladimir Yakovlev pages 453-464 has instructions on configuring this.

Here are the steps for configuring IDC in our Lab.

- Configure in SmartConsole
  - Create LDAP account unit
    - New > More > User/Identity > LDAP Account Unit
      - General tab
        - Name: xcpng.lab_account_unit
        - Profile: Microsoft_AD
        - Domain: xcpng.lab
        - Account Unit usage
          - CRL retrieval: Not checked
          - User management: Checked (default)
          - Activity Directory Query: default not checked
      - Servers tab
        - Add
          - Host: dc-1
          - Port: 389 (default)
          - Username: adquery
          - Login DN: DC=xcpng,DC=lab
          - Password: YourStrongPassword123!
          - Read data from this server: Checked (default)
          - Write data to this server: Checked (default)
          - Click OK
      - Objects Management tab
        - Click Fetch branches
          - Or manually DC=xcpng,DC=lab
        - Failure message: Failed to connect to LDAP Server. Please ensure the administrator's credentials are correct and try again
      - Authentication tab
        - Use common group path for queries (unchecked, default)
        - Allowed authentication schemes
          - Check Point Password (checked, default)
          - SecurID (checked, default)
          - RADIUS (checked, default)
          - OS Password (checked, default)
          - TACACS (checked, default)
        - Users' default values
          - Use user template (unchecked, default)
          - Default authentication scheme (unchecked, default)
        - Limit login failures (unchecked, default)
        - Encryption
          - IKE pre-shared secret encryption key: blank (default)
  - Edit cluster firewall1
    - Enable Identity Awareness Blade
      - AD Query
      - Select an Active Directory: xcpng.lab
      - Username: adquery
      - Password: YourStrongPassword123!
      - Click Connect
        - Failure message: User is not a domain administrator, as such AD Query will not work.
        - Check Ignore the errors and configure the LDAP account
        - Login ID: CN=adquery,OU=Automation Accounts,OU=Corp,DC=xcpng,DC=lab
    - Check Identity Collector, and click Settings
      - Click the "+" and add **idc-1**
      - Shared secret: Checkpoint123!
      - Click OK
    - Click OK
    - Publish and install policy
  - Testing
    - Log in to IDC-1
    - Launch Identity Collector
    - From the left, click Gateways
      - Edit firewall1
      - Test and Trust the certificate
    - From the left menu click Logins Monitor
    - Click the small power icon next to the text "Logins Monitor"
    - Log in to branch-1 using a domain user account
    - Back in the Identity Collector, click the refresh icon
    - The login will show in the top pane and the related machine and user in the bottom pane
    - Log in the Firewalla or Firewallb
    - `pep show user all`
    - Note that identities are being passed to the firewall
  - Create Access role
    - Add a subrule above the rule allowing medium/low/very low risk applications
    - Name: Allow support access to sites
    - Source: New > Access Role
      - Object name: Support
      - Networks: Specified Networks, add branch1_lan
      - Users: Specific users/grpus
        - Click "+" to add, and search for support
        - Click on Support
      - Machines: All identified machines (machines identified by a supported authenticated method, i.e. Active Directory)
      - Remote Access Clients: Leave at Any Client
    - Destination: New > Other > Domain> .ipgiraffe.com (FQDN)
    - Action: Accept
    - Track: Log
  - Add another subrules to deny all access to ipgiraffe.com
    - Name: Deny all nonsupport access to sites
    - Source: Any
    - Destination .ipgiraffe.com
    - ServiceS: Any
    - Action: Drop > Blocked Message
    - Track: Log
  - Publish changes and push policy
  - Test

# Configure Branch 2
## Add branch 2 to Domain Controller
- Configure Sites and Services Subnets and DNS
  - Run on `dc-1`
    - branch2-site.ps1 ([branch2-site.ps1](powershell/branch2-site.ps1))
    - `powershell -ExecutionPolicy Bypass branch2-site.ps1`
- Configure DC-1 as DHCP server for branch 2
  - branch2-dhcp.ps1 ([branch2-dhcp.ps1](powershell/branch2-dhcp.ps1))
  - `powershell -ExecutionPolicy Bypass branch2-dhcp.ps1`
  - 🌱 this script overwrites the branch1 scope router setting and BREAKS everything

## Enable SMS to manange remote gateways
- Create file on `manager`
  - [branch2-enablesms.yml](ansible/branch2-enablesms.yml)
- Apply the changes
  - `ansible-playbook -i inventory-api branch2-enablesms.yml`
- R81.1: Enable "Apply for Security Gateway control connections"
  - Edit `sms` object
  - Under NAT, <ins>check</ins> "Apply for Security Gateway control connections"
  - Publish changes
- Push policy `Lab policy` to **firewall1** to enable the SMS to connect to Branch 2
    -  ansible-playbook -i inventory-api branch1-push.yml`

## Initial Configuration
Steps:
- BEFORE you POWER ON the firewalls **firewall2a** and **firewall2b**
  - Turn off TX checksumming on each interface
  - Click Network tab
  - For each interface click the blue gear and click to set TX checksumming **Disabled**
- Power on **firewall2a** and **firewall2b**
- Log in to consoles of **firewall2a** and **firewall2b**
  - Username `admin` and the password you selected
- Set IP address information
  - firewall2a
    - `set interface eth0 ipv4-address 192.168.102.2 mask-length 24`
    - `set static-route default nexthop gateway address 192.168.102.254 on`
    - `save config`
  - firewall2b
    - `set interface eth0 ipv4-address 192.168.102.3 mask-length 24`
    - `set static-route default nexthop gateway address 192.168.102.254 on`
    - `save config`
- Add `manager`'s RSA keys to each firewall's authorized_keys file
  - Log in to `manager` and open a WSL shell
    - ssh to firewall1a and firewall1b
      - `ssh ansible@192.168.102.2`
      - `ssh ansible@192.168.102.3`
      - you will be in the default home directory `/home/ansible`
  - Create new authorized_keys file and add the key
    - `mkdir .ssh`
    - `chmod u=rwx,g=,o= ~/.ssh`
    - `touch ~/.ssh/authorized_keys`
    - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
    - Add the public key from `manager` to the files
      - `cat > ~/.ssh/authorized_keys`
        - paste in the key
        - press Control-D
    - `exit`
  - You can now ssh without a password
- Test Ansible access
  - Exit back to session on `manager`
  - update file `inventory`, uncomment the IPs of firewall2a (192.168.102.2) and firewall2b (192.168.102.3)
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for both firewalls

## Configure Gaia
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS
  - [firewall2a.yml](ansible/firewall2a.yml)
  - [firewall2a.cfg](ansible/firewall2a.cfg)
  - [firewall2b.yml](ansible/firewall2b.yml)
  - [firewall2b.cfg](ansible/firewall2b.cfg)
  - [branch2.j2](ansible/branch2.j2)
- Run the playbooks to complete the first time wizard (FTW) and reboot
  - `ansible-playbook firewall2a.yml`
  - `ansible-playbook firewall2b.yml`
- Test
  - You will be able to connect from manager to
    - https://192.168.102.2
    - https://192.168.102.3

## Configure cluster and policy
- Create objects in the Check Point database related to Branch 2
  - Create file on `manager`
    - [branch2-objects.yml](ansible/branch2-objects.yml)
  - `ansible-playbook -i inventory-api branch2-objects.yml`
- Create cluster using API
  - https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/content/module/cp_mgmt_simple_cluster/
  - Create file on `manager`
    - [firewall2-cluster.yml](ansible/firewall2-cluster.yml)
  - `ansible-playbook -i inventory-api firewall1-cluster.yml`
- Create new policy using API
  - [branch2-policy.yml](ansible/branch2-policy.yml)
    - `ansible-playbook -i inventory-api branch2-policy.yml`
- Push policy
  - [branch2-push.yml](ansible/branch2-push.yml)
    - `ansible-playbook -i inventory-api branch2-push.yml`
    - This policy permits LAN to use 8.8.8.8 and 8.8.4.4 for DNS for testing
      - Create a Windows 10 workstation on branch2 and set static IP information
      - 10.0.2.25/24 DNS 8.8.8.8 and gateway 10.0.2.1
- Test that ansible can still manage firewall2 cluster members
  - `ansible all -m ping`
- At this point you should be able to install a JHF on the firewalls
  - SSH or console to each device (sms, firewall2a, firewall2b)
  - `clish`
  - `installer check-for-updates`
  - `installer download-and-install [tab]`
  - select the applicable JHF hotfix bundle by number
  - Approve the reboot

## VPN
  - Create file on `manager`
    - [branch2-vpn.yml](ansible/branch2-vpn.yml)
  - `ansible-playbook -i inventory-api branch2-vpn.yml`
  - Use SmartConsole to edit the community **Branch_Community**
    - Advanced: Check **Disable NAT inside the VPN community** (Both center and satellite gateways)
  - Testing
    - 🌱 need to develop the testing

## Configure branch2-1
- We will configure workstation branch2-1 with a static IP and later switch to DHCP
- Log in for the first time at the console
  - Rename workstation
    - Open administrative powershell
    - `Rename-Computer -NewName branch2-1`
    - `Restart-Computer`
  - Network configuration
    - Open administrative powershell
    - Set the static IP address and point DNS settings to the domain controller/DNS server
      - `New-NetIPAddress -IPAddress 10.0.2.100 -DefaultGateway 10.0.2.1 -PrefixLength 24 -InterfaceIndex (Get-NetAdapter).InterfaceIndex`
    - `Set-DNSClientServerAddress -InterfaceIndex (Get-NetAdapter).InterfaceIndex -ServerAddresses 10.0.1.10`
    - Try testing nslookup to see what resolves (IPs, FQDN)
  - Join to domain
    - Open administrative powershell
    - `Add-Computer -DomainName xcpng.lab -restart`
      - User name: `AD\Juliette.LaRocco2` (or, XCPNG.LAB\juliette.larocco2)
      - Password: the password you set
- Testing
  - Log in as Other user > juliette.larocco
    - Try conntecting to the file server at \\file-1
    - Confirm Internet browser is working
    - Review logs

## Enable Application Control and Identity Awareness
- Edit cluster **firewall2**
  - Enable **Application Control** and **URL Filtering** blades
  - Enable **Identity Awareness** blade
    - AD Query
    - Select an Active Directory: xcpng.lab
    - Username: adquery
    - Password: YourStrongPassword123!
    - Click **Connect**
      - Failure message: User is not a domain administrator, as such AD Query will not work.
      - Check **Ignore the errors and configure the LDAP account**
      - Login ID: CN=adquery,OU=Automation Accounts,OU=Corp,DC=xcpng,DC=lab
    - Click Identity Awareness from tree on the left
    - Check Identity Collector, and click Settings
    - Click the "+" and add **idc-1**
    - Shared secret: Checkpoint123!
    - Client Access Permissions > **Edit** > select **through all interfaces** and click **OK**
    - Click OK
  - Click OK
  - Publish and install policy **Lab_Policy_Branches**
- IDC-1
  - From the ribbon menu click Filters
    - Edit filter **Prod**
      - Add network:
        - Network: 10.0.2.0/24
        - Comment: Branch 2 LAN
  - From left menu click **Gateways**
    - Add new Gateway
      - Name: **firewall2**
      - IP Address: 10.0.2.1
      - Shared Secret: Checkpoint123!
      - Query Pool: Corp AD
      - Filter: Prod
      - Click OK
      - Edit the new gateway and click Test
🌱 The following changes can likely be done using Ansible and the API. Need to test.
- TIP You can copy and paste rules from Lab_Policy to Lab_Policy_Brances
- Open the Access Policy and find the section **General Internet access**
- Find the rule **General Internet access**
- Change action from **Accept** to **Inline Layer > New Layer**
  - Name: **Internet Control Branches**
  - Blades:
    - Firewall (checked)
    - Applications & URL Filtering (checked)
  - Advanced > Implicit Cleanup Action: **Allow**
  - Confirm action is Accept and is set to Log
- Rename the cleanup rule **Allow remaining traffic**
- Add these sub rules above that
  - Subrule 1
    - Name: Block bad sites
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Hacking
      - Pornography
      - Phishing
      - Weapons
      - Critical Risk
      - High Risk
    - Action: **Drop > Blocked Message - Access Control**
    - Track: Log > Accounting
  - Subrule 2
    - Name: Allow general categories
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Medium Risk
      - Low Risk
      - Very Low Risk
    - Action: Accept
    - Track: Log > Accounting
  - Subrule 3
    - Name: Unknown risk
    - Source: *Any
    - Destination: *Any
    - Services & Applications:
      - Uncategorized
      - Unknown Risk
    - Action:
      - Inform
        - Access Approval
        - Once a day
        - Per applications
    - Track: Log > Accounting

## HTTPS inspection
- Non-ansible/manual solutions here since ansible check_point.mgmt doesn't support all the commands until R82
  - creating https rules, etc not supported until R82
  - some outbound certificate commands function differently pre-R82
  - `enable-https-inspection` will be added in the next version
- Enable HTTPS inspection on **firewall2**
  - Open the cluster `firewall2`
  - Click on HTTPS Ispection
  - Steps 1 and 2 are already completed
  - Step 3 check **Enable HTTPS inspection**
  - Click OK
- Publish and install policy Lab_Policy_Branches
- Click OK and Publish
- Confirm the HTTPS policy is the same across Lab_Policy and Lab_Policy_Branches
- Test from branch2-1
  - Run `gpupdate /force` at a shell to trigger an immediate group policy update (by default periodic refresh every 90 minutes with a randomized offset of up to 30 minutes)
  - Browse to an internet site like https://github.com and examine the https certificate
    - Edge browser: click the lock next to the URL > Connection is secure
      - Click the Cerificifate icon
      - If https inspection is working, the Issued By will new reflect xcpng.lab
      - Examine logs
  - If the traffic is inspected and intercepted but not trusted by the browser
    - Logging out and back in may also help
    - Confirm the certificate is installed
      - Start > Internet Options > Content
      - Click Certificates and select the Trusted Root Certification Authorities tab
  - If the traffic not intercepted at all
    - add a rule to the HTTPS policy, publish and push, then try again

## Add Identity-Based Management
- Add an access rule to the Lab_Policy and Lab_Policy_Branches
  - TIP You can create in one policy and copy it to the other
  - Name: **RDP access for Support**
  - Source: **Suppport** (access role)
  - Destination: **LAN_Networks_NO_NAT**
  - Services:
    - **Remote_Desktop_Protocol**
    - **Remote_Desktop_Protocol_UDP**
  - Action: **Accept**
  - Track: **Log**
  - Comments: **Allow support team RDP access**
- Modify the **Support** access role
  - Networks: Add **LAN_Networks_NO_NAT**, remove **branch1_lan**
- Push both policies, Lab_Policy and Lab_Policy_Branches
- 🌱 need to develop
  - firewall1 is allowing it, but on firewall2 it is dropped
    - firewall2: `pep show user all` doesn't show logins
    - firewall2 isn't getting logins, not even on branch2-1

## Configure DHCP helper and DHCP
- Log in to firewall2a and firewall2b
  - `clish`
  - `set bootp interface eth1 on`
  - `set bootp interface eth1 relay-to 10.0.1.10 on`
  - `save config`
- Lab_Policy
  - Add section **DHCP** above section **Stealth Rules**
    - Add rule
      - Name: DHCP requests
      - Source: firewall2
      - Destination: dc-1
      - Service: bootp (udp/67)
      - Action: Accept
      - Track: None (it's OK to turn it on for troubleshooting and testing initial setup)
      - Comments: DHCP requests
    - Add rule
      - Name: DHCP replies
      - Source: dc-1
      - Destination: firewall2
      - Service: bootp (udp/67)
      - Action: Accept
      - Track: None (it's OK to turn it on for troubleshooting and testing initial setup)
      - Comments: DHCP replies
- Lab_Policy_Branches
  - Add section **DHCP** above section **Stealth Rules**
    - Add rule
      - Name: DHCP broadcasts
      - Source: *Any
      - Destination: broadcast_255.255.255.255
      - Service: bootp (udp/67)
      - Action: Accept
      - Track: None (it's OK to turn it on for troubleshooting and testing initial setup)
      - Comments: DHCP broadcasts
    - Add rule
      - Name: DHCP requests
      - Source: firewall2
      - Destination: dc-1
      - Service: bootp (udp/67)
      - Action: Accept
      - Track: None (it's OK to turn it on for troubleshooting and testing initial setup)
      - Comments: DHCP requests
    - Add rule
      - Name: DHCP replies
      - Source: dc-1
      - Destination: firewall2
      - Service: bootp (udp/67)
      - Action: Accept
      - Track: None (it's OK to turn it on for troubleshooting and testing initial setup)
      - Comments: DHCP replies

## Configure branch2-1 to use DHCP
- Change the IP address to use DHCP

# Configure Branch 3
🌱 this needs to be developed
## Add branch 3 to Domain Controller
- Configure Sites and Services Subnets and DNS
  - Run on `dc-1`
    - branch3-site.ps1 ([branch3-site.ps1](powershell/branch3-site.ps1))
    - `powershell -ExecutionPolicy Bypass branch3-site.ps1`
- Configure DC-1 as DHCP server for branch 3
  - branch3-dhcp.ps1 ([branch3-dhcp.ps1](powershell/branch3-dhcp.ps1))
  - `powershell -ExecutionPolicy Bypass branch3-dhcp.ps1`

## Initial Configuration
Steps:
- BEFORE you POWER ON the firewalls **firewall3a** and **firewall3b**
  - Turn off TX checksumming on each interface
  - Click Network tab
  - For each interface click the blue gear and click to set TX checksumming **Disabled**
- Power on **firewall3a** and **firewall3b**
- Log in to consoles of **firewall3a** and **firewall3b**
  - Username `admin` and the password you selected
- Set IP address information
  - firewall3a
    - `set interface eth0 ipv4-address 192.168.103.2 mask-length 24`
    - `set static-route default nexthop gateway address 192.168.103.254 on`
    - `save config`
  - firewall3b
    - `set interface eth0 ipv4-address 192.168.103.3 mask-length 24`
    - `set static-route default nexthop gateway address 192.168.103.254 on`
    - `save config`
- Add `manager`'s RSA keys to each firewall's authorized_keys file
  - Log in to `manager` and open a WSL shell
    - ssh to firewall3a and firewall3b
      - `ssh ansible@192.168.103.2`
      - `ssh ansible@192.168.103.3`
      - you will be in the default home directory `/home/ansible`
  - Create new authorized_keys file and add the key
    - `mkdir .ssh`
    - `chmod u=rwx,g=,o= ~/.ssh`
    - `touch ~/.ssh/authorized_keys`
    - `chmod u=rw,g=,o= ~/.ssh/authorized_keys`
    - Add the public key from `manager` to the files
      - `cat > ~/.ssh/authorized_keys`
        - paste in the key
        - press Control-D
    - `exit`
  - You can now ssh without a password
- Test Ansible access
  - Exit back to session on `manager`
  - update file `inventory`, uncomment the IPs of firewall3a (192.168.103.2) and firewall2b (192.168.103.3)
  - `ansible all -m ping`
    - You are expecting `SUCCESS` and `"ping": "pong"` for both firewalls

## Configure Gaia
- Create files on the manager (variables file, playbook to create SMS, and the jinja template for the SMS
  - [firewall3a.yml](ansible/firewall3a.yml)
  - [firewall3a.cfg](ansible/firewall3a.cfg)
  - [firewall3b.yml](ansible/firewall3b.yml)
  - [firewall3b.cfg](ansible/firewall3b.cfg)
  - [branch3.j2](ansible/branch3.j2)
- Run the playbooks to complete the first time wizard (FTW) and reboot
  - `ansible-playbook firewall3a.yml`
  - `ansible-playbook firewall3b.yml`
- Enable DHCP relay on each
  - `clish`
  - `set bootp interface eth1 on`
  - `set bootp interface eth1 relay-to 10.0.1.10 on`
  - `save config`
- Test
  - You will be able to connect from manager to
    - https://192.168.103.2
    - https://192.168.103.3

## Configure cluster and policy
- Create objects in the Check Point database related to Branch 3
  - Create file on `manager`
    - [branch3-objects.yml](ansible/branch3-objects.yml)
  - `ansible-playbook -i inventory-api branch3-objects.yml`
- Create cluster using API
  - https://galaxy.ansible.com/ui/repo/published/check_point/mgmt/content/module/cp_mgmt_simple_cluster/
  - Create file on `manager`
    - [firewall3-cluster.yml](ansible/firewall3-cluster.yml)
  - `ansible-playbook -i inventory-api firewall3-cluster.yml`
- Create new policy using API
  - [branch3-policy.yml](ansible/branch3-policy.yml)
    - `ansible-playbook -i inventory-api branch3-policy.yml`
- Edit cluster **firewall3**
  - Enable **Application Control** and **URL Filtering** blades
  - Enable **Identity Awareness** blade
    - AD Query
    - Select and Active Directory: xcpng.lab
    - Username: adquery
    - Password: YourStrongPassword123!
    - Click **Connect**
      - Failure message: User is not a domain administrator, as such AD Query will not work.
      - Check **Ignore the errors and configure the LDAP acount**
      - Login ID: CN=adquery,OU=Automation Accounts,OU=Corp,DC=xcpng,DC=lab
    - Click Identity Awareness from tree on the left
      - Check Identity Collector, and click Settings
      - Click the "+" and add idc-1
      - Shared secret: Checkpoint123!
      - Client Access Permissions > Edit > select through all interfaces and click OK
      - Click OK
  - [branch3-push.yml](ansible/branch3-push.yml)
    - `ansible-playbook -i inventory-api branch3-push.yml`
- Test that ansible can still manage firewall3 cluster members
  - `ansible all -m ping`
- At this point you should be able to install a JHF on the firewalls
  - SSH or console to each device (sms, firewall3a, firewall3b)
  - `clish`
  - `installer check-for-updates`
  - `installer download-and-install [tab]`
  - select the applicable JHF hotfix bundle by number
  - Approve the reboot
- IDC-1
  - From the ribbon menu click Filters
    - Edit filter **Prod**
    - Add network:
      - Network: 10.0.3.0/24
      - Comment: Branch 3 LAN
  - From left menu click **Gateways**
    - Add new Gateway
      - Name: **firewall3**
      - IP Address: **10.0.3.1**
      - Shared Secret: **Checkpoint123!**
      - Query Pool: **Corp AD**
      - Filter: **Prod**
      - Click **OK**
      - Edit the new gateway and click Test

## VPN
  - Create file on `manager`
    - [branch3-vpn.yml](ansible/branch3-vpn.yml)
  - `ansible-playbook -i inventory-api branch3-vpn.yml`
  - Testing
    - 🌱 need to develop the testing

# Demonstration
🌱 this needs to be developed
- branches 2 and 3
  - access to file server
  - access to DMZ web servers
  - internet access goes out local firewalsl
  - support team can access and support
- secured access to Internet, blocking prohibited access
- examine peer-to-peer access between branches
- DHCP across branches
- identity awareness for access
