# Set Up Pentesting Lab

NOTE At this point you will need Internet access to download content and update some of your systems. This will probably use your regular Lab Internet.

Before doing any "live fire" testing, take one of the following steps:
- Disable/block/prevent traffic from the pentesing network outside of the isolated subnet
- Secure the connection to the Internet using a VPN
- Anonymize the Internet connection using Tor

# Install Kali Linux VM
Kali Linux is a popular distribution for pentesting.
- From the left menu click **New** > **VM**
  - Select the pool **xcp-ng-lab1**
  - Template: *Other install media*
  - Name: **kali**
  - Description: **Kali Linux on pentesting network**
  - CPU: **1vCPU** or more for heavier workloads
  - RAM: **2GB minimum**, 4GB or more recommended (much more if you are running virtual machines on Kali)
  - Topology: Default behavior
  - Install: ISO/DVD: *Select the Kali iso you uploaded*
  - Interfaces: select **Pentesting** from the dropdown
  - Disks: Add a disk **60GB** (20GB minimum; OpenVAS takes a lot more space and will fail at 20GB; even more if you will be working with large data objects
  - Click **Create**
- Click **Console** tab
- Follow the installation wizard
  - Select **Graphical Install**
  - Select language, location, keyboard layout
  - Hostname: **kali**
  - Domain name: **xcpng.lab**
  - Full name: **kali** (feel free to customize)
  - Username: **kali**
  - Password: *select a password*
  - Select timezone
  - Accept Guided partition, use entire disk and set up LVM
  - Confirm the disk to be used
  - Accept all files in one partition for this Lab
  - Approve making the change, approve the size, approve writing the changes to disk
  - Accept the default desktop and packages (feel free to customize)
  - Wait patiently as packages copied unpacked and installed
  - Accept installing the GRUB boot loader, and select the device
  - When prompted, eject the installation iso and click Continue to reboot
- Log in
- Update software packages
  - `sudo apt update && sudo apt upgrade -y`
  - To upgrade to the latest Kali version:
    - `sudo apt full-upgrade -y`
- Install guest tools
  - The guest-tools.iso method wasn't working
  - Download the tools
    - https://www.xenserver.com/downloads
    - Download XenServer tools for Linux
    - tar xzvf LinuxGuestTools-8.4.0-1.tar.gz
    - cd LinuxGuestTools-8.4.0-1
  - Kali is based on Debian, this release on is on bookworm
  - `sudo ./install.sh -d debian -m bookworm`
    - press y
  - `reboot`

# Deploy more VMs
Here are some systems to create on the Pentesting network
- Up-to-Date systems
  - Windows 10/11
    - Optionally, deliberately make it vulnerable
      - https://medium.com/@bmatth21/how-to-setup-windows-10-vm-lab-for-hacking-608592d550f2
      - http://cyberforensic.net/labs/AutoPatch_Removal.html
  - Windows Server 2022
    - Optionally set up a domain, file server, workstations, etc.
  - Ubuntu Desktop or Server
  - Other distros like FreeBSD
- Vulnerable/Out-of-Date systems
  - some downright dangerous with critical unpatched vulnerabilities and should only be added AFTER you secure/isolate the pentesting lab
  - Windows 7
  - Windows XP ☠️
  - Older versions of Ubuntu
    - https://ubuntu.com/security/notices and select a release to see the vulnerabilities
    - OpenSSH are good examples of vulnerabilities you will find
    - https://www.netspi.com/blog/technical-blog/network-pentesting/linux-hacking-case-studies-part-5-building-a-vulnerable-linux-server/

# Ready for Pentesting
This Lab does not provide complete step-by-step pentesting examples. However, here is a basic sequence of testing you can do.

## Discovery
### netdiscover
netdiscover as a tool for active and passive ARP reconnaissance. it sends ARP requests and analyzes responses to identify active devices. Can potentially identify the device vendor (OUI lookup)
- `sudo netdiscover`

### nmap
nmap is a powerful network scanner with a robust set of tools and scripts. Beyond MAC address, it can identify open and closed ports. This information can ube used for service identification and identifying vulnerable sevices.
- `nmap -sn 192.168.101.0/24`
- `nmap -A 192.168.101.0/24`

- Linux and SSH
  - `sudo nmap -p 22 -sS 192.168.101.0/24`
  - `nmap -p 22 -sV 192.168.101.0/24`

- Windows machines and SMB
  - nmap scripts (`/usr/share/nmap/scripts`)
    - Win10 often doesn't respond to ping, add -Pn as needed
    - You will discover more things after you create a file share on the target Windows sysetm
      - Use "Optional features" (more Windows features) to enable "SMB 1.0/CIFS server" and "Internet Information Services"
    - `nmap --script smb-system-info.nse <target>`
    - `nmap --script smb-os-discovery.nse <target>`
    - `nmap --script smb2-capabilities.nse <target>`
    - `nmap --script smb-enum-shares.nse <target>`
    - `nmap --script smb-security-mode.nse <target>`

### enum4linux
enum4linux enumerates SMB share information
- `enum4linux - [cheat sheet](https://highon.coffee/blog/enum4linux-cheat-sheet/)
  - `enum4linux 192.168.101.22`
  - Using credentials
    - `enum4linux -u lab -p lab -a 192.168.101.22`

## Finding Vulnerabilities
### Nikto
Nikto is a web server scanner that looks for harmful files and checks for outdated software.
- `nikto -h <target_IP>`
Lots of output, focus on
- Overview
- Server Information
- Look for keywords suspicious, outdated, vulnerable

### OpenVAS
References:
- https://hassen-hannachi.medium.com/installing-openvas-on-kali-linux-a54baeaf806a
- https://greenbone.github.io/docs/latest/22.4/kali/index.html
- https://forums.kali.org/showthread.php?71778-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2022-1
- https://forums.kali.org/showthread.php?150733-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2023-2a&highlight=openvas

- Setup
  - `sudo apt update && sudo apt upgrade -y`
  - `sudo /etc/init.d/postgresql start`
  - `sudo apt install -y  --install-recommends gvm`
  - `sudo gvm-setup`
    - Wait patiently for this to complete (it takes a <ins>long time</ins> to download all the data)
    - Note the admin account name and password (it's a long randomly generated password)
    - Reset password to something easier: `sudo gvmd --user=admin --new-password=passwd`
  - Create user kali
    - `sudo runuser -u _gvm -- gvmd --create-user=kali`
    - `sudo runuser -u _gvm -- gvmd --user=kali --new-password=kali`
  - Verify installation: `sudo gvm-check-setup`
  - ? `sudo systemctl start redis-server@openvas.service`
  - ? `sudo systemctl enable redis-server@openvas.service`
  - `sudo gvm-stop`
  - Sync the data/configs:
    - `sudo runuser -u _gvm -- greenbone-nvt-sync`
    - `sudo gvm-feed-update`
  - Fix for `Failed to find config 'daba56c8-73ec-11df-a475-002264764cea'`
    - `sudo runuser -u _gvm -- gvmd --get-scanners`
    - `sudo runuser -u _gvm – gvmd --get-users --verbose`
    - `sudo runuser -u _gvm -- gvmd --modify-scanner [scanner id] --value [user id]`
    - `gvmd --modify-setting 78eceaec-3385-11ea-b237-28d24461215b --value <uuid_of_user>`
    - sudo /etc/init.d/postgresql start
    - sudo -u postgres psql
    - ALTER DATABASE postgres REFRESH COLLATION VERSION;
    - `\q`
- Starting and Stopping
  - OpenVAS uses a LOT of resources, so only start OpenVAS when needed, and stop it when done
  - `sudo gvm-start`
  - `sudo gvm-stop`
- Logging in
  - `sudo gvm-start`
  - https://localhost:9392
  - Log in using the username and password set earlier
    - `kali`/`kali`
- First Scan
  - Scans > Tasks > Magic wand - Task Wizard
  - Enter IP to scan right away
    - Failed to find config 'daba56c8-73ec-11df-a475-002264764cea'
    - "The SCAP database is required"
    - the setup check passed....
  - scan a target ip with vuln scan template like "Full OpenVAS Security Check"

Using the results:
- Focus on High and Medium; see software information and potential exploits (CVEs)
- Look for exploitable CVEs and if public available exploits exist

## Attack and exploit tools
- Responder - fake server; does relaying; deals with POP IMAP SMTP SQL queries MLMNR, NBT; recover usernames and passwords
- Metasploit - validate and launch exploits (paid version provides GUI)
- ettercap - ARP poisoning

## Misellaneous tools
- Searchsploit - enables search database of exploits/archive; see if a system may be vulnerable to a specific exploit


