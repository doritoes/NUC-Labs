# Set Up Pentesting Lab

NOTE At this point you will need Internet access to download content and update some of your systems. This will probably use your regular Lab Internet.

Before doing any "live fire" testing, take one of the following steps:
- Disable/block/prevent traffic from the pentesting network outside of the isolated subnet
- Secure the connection to the Internet using a VPN
- Anonymize the Internet connection using Tor

# Install Kali Linux VM
Kali Linux is a popular distribution for pentesting. Find ISO images at https://www.kali.org/get-kali/#kali-installer-images
- From the left menu click **New** > **VM**
  - Select the pool **xcp-ng-lab1**
  - Template: *Other install media* (Note that is based off the Debian testing branch, so you may want to test with a Debian template)
  - Name: **kali**
  - Description: **Kali Linux on pentesting network**
  - CPU: **4 vCPU** because we will be using OpenVAS (Greenbone vulnerability manager)
  - RAM: **4 GB minimum** because we will be using OpenVAS
  - Topology: Default behavior
  - Install: ISO/DVD: *Select the Kali iso you uploaded*
  - Interfaces: select **Pentesting** from the dropdown
  - Disks: Add a disk **60GB** (20GB minimum; OpenVAS takes a lot more space and will fail at 20GB; even more if you will be working with large data objects
  - Click **Create**
- Click **Console** tab
- Follow the installation wizard
  - Select **Graphical Install**
  - Select language, location, keyboard layout
  - Hostname: **kali**
  - Domain name: **xcpng.lab**
  - Full name: **kali** (feel free to customize)
  - Username: **kali**
  - Password: *select a password*
  - Select timezone
  - Accept Guided partition, use entire disk and set up LVM
  - Confirm the disk to be used
  - Accept all files in one partition for this Lab
  - Approve making the change, approve the size, approve writing the changes to disk
  - Accept the default desktop and packages (feel free to customize)
  - Wait patiently as packages are copied unpacked and installed
  - Accept installing the GRUB boot loader, and select the device
  - When prompted, eject the installation iso and click Continue to reboot
- Log in
- Update software packages
  - `sudo apt update && sudo apt upgrade -y`
  - To upgrade to the latest Kali version:
    - `sudo apt full-upgrade -y`
- Install guest tools
  - The guest-tools.iso method wasn't working
  - Download the tools
    - https://www.xenserver.com/downloads
    - Download XenServer tools for Linux 8.4.0-1
    - Move to user directory and unpack
      - `mv ~/Downloads/LinuxGuestTools-8.4.0-1.tar.gz ~`
      - tar xzvf LinuxGuestTools-8.4.0-1.tar.gz
    - Install
      - cd LinuxGuestTools-8.4.0-1
      - Kali is based on Debian, this release is on trixie
      - `sudo ./install.sh -d debian -m trixie`
      - press y
    - `reboot`
- Take a snapshot of this "clean" Kali VM in case you need to revert later
  - Click on the kali VM, then Snapshots tab
  - Click New snapshot
# Deploy more VMs
Here are some systems to create on the Pentesting network
- Up-to-Date systems
  - Windows 10/11
    - Optionally, deliberately make it vulnerable
      - https://medium.com/@bmatth21/how-to-setup-windows-10-vm-lab-for-hacking-608592d550f2
      - http://cyberforensic.net/labs/AutoPatch_Removal.html
  - Windows Server 2025
    - Optionally set up a domain, file server, workstations, etc.
  - Ubuntu Desktop or Server
  - Other distros like FreeBSD
- Vulnerable/Out-of-Date systems
  - some downright dangerous with critical unpatched vulnerabilities and should only be added AFTER you secure/isolate the pentesting lab
  - Windows 8.1
  - Windows 7
  - Windows XP ☠️ (64-bit version of XP exists)
  - Server 2019, 2003 R2
  - Older versions of Ubuntu (64-bit)
    - https://ubuntu.com/security/notices and select a release to see the vulnerabilities
    - OpenSSH are good examples of vulnerabilities you will find
    - https://www.netspi.com/blog/technical-blog/network-pentesting/linux-hacking-case-studies-part-5-building-a-vulnerable-linux-server/

# Ready for Pentesting
This Lab does not provide complete step-by-step pentesting examples. However, here is a basic sequence of testing you can do.

## Discovery
Start on the kali VM.

### netdiscover
netdiscover as a tool for active and passive ARP reconnaissance. it sends ARP requests and analyzes responses to identify active devices. Can potentially identify the device vendor (OUI lookup)
- `sudo netdiscover`
  - in testing, this command scanned all RFC 1918 addresses by default
  - Faster: `sudo netdiscover -f`
  - Just the network attached to the Kali box: `sudo netdiscover -i eth0`
  - Scan a range: `sudo netdiscover -r 192.168.101.0/24`
- It's also in the menu under `09 - Discovery`

### nmap
nmap is a powerful network scanner with a robust set of tools and services
scripts. Beyond MAC address, it can identify open and closed ports. This information can be used for service identification and identifying vulnerable services.
- `nmap -sn 192.168.101.0/24`
- `nmap -A 192.168.101.0/24`

- Linux and SSH
  - `sudo nmap -p 22 -sS 192.168.101.0/24`
  - `nmap -p 22 -sV 192.168.101.0/24`

- Windows machines and SMB
  - nmap scripts (`/usr/share/nmap/scripts`)
    - Win10 often doesn't respond to ping, add -Pn as needed
    - You will discover more things after you create a file share on the target Windows system
      - Use "Optional features" (more Windows features) to enable "SMB 1.0/CIFS server" and "Internet Information Services"
    - `nmap --script smb-system-info.nse <target>`
    - `nmap --script smb-os-discovery.nse <target>`
    - `nmap --script smb2-capabilities.nse <target>`
    - `nmap --script smb-enum-shares.nse <target>`
    - `nmap --script smb-security-mode.nse <target>`

### enum4linux
enum4linux enumerates SMB share information
- `enum4linux` - [cheat sheet](https://highon.coffee/blog/enum4linux-cheat-sheet/)
  - `enum4linux 192.168.101.22`
  - Using credentials
    - `enum4linux -u lab -p lab -a 192.168.101.22`

## Finding Vulnerabilities
### Nikto
Nikto is a web server scanner that looks for harmful files and checks for outdated software.
- `nikto -h <target_IP>`
Lots of output, focus on
- Overview
- Server Information
- Look for keywords suspicious, outdated, vulnerable

### OpenVAS
References:
- https://hassen-hannachi.medium.com/installing-openvas-on-kali-linux-a54baeaf806a
- https://greenbone.github.io/docs/latest/22.4/kali/index.html
- https://forums.kali.org/showthread.php?71778-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2022-1
- https://forums.kali.org/showthread.php?150733-HowTo-Installation-procedure-of-OpenVAS-on-Kali-Linux-2023-2a&highlight=openvas

- Setup (on the `kali` VM is find for this Lab)
  - `sudo apt update && sudo apt upgrade -y`
  - `sudo apt install -y --install-recommends gvm`
  - `sudo gvm-setup`
    - Wait patiently for this to complete (it takes a <ins>long time</ins> to download all the data)
    - Note the admin account name and password (it's a long randomly generated password)
    - Reset password to something easier: `sudo gvmd --user=admin --new-password=passwd`
  - Create user kali
    - `sudo runuser -u _gvm -- gvmd --create-user=kali`
    - `sudo runuser -u _gvm -- gvmd --user=kali --new-password=kali`
  - Verify installation: `sudo gvm-check-setup`
    - NOTE This starts gvm (OpenVAS)
- Starting and Stopping
  - OpenVAS uses a LOT of resources, so only start OpenVAS when needed, and stop it when done
    - The Kali menu under `02 - Vulnerability`
      - `gvm start`
      - `gvm stop`
  - Command line
    - `sudo gvm-start`
    - `sudo gvm-stop`
- Logging in
  - Make sure GVM is started
  - https://localhost:9392
  - Log in using the username and password set earlier
    - `kali`/`kali`
- Make sure feeds are loaded before continuing
  - From the menu click **Administration** > **Feed Status**
  - Wait until all the Feed Status show **Current**
  - If you run `top` you will see postgres can only use one processor, and it's taking a long time
- First Scan
  - After your Feeds are Loaded, try your first scan
  - Scans > Tasks > Magic wand - Task Wizard
  - Enter IP to scan right away
    - First time: accept 127.0.0.1
  - If you get the error "Failed to find config 'daba56c8-73ec-11df-a475-002264764cea'"
    - Make sure the feed status changes crom Update in Progress... to current
    - Make sure you hve 4 vCPUs+ and 4GB+ RAM
- Continue with scans of the rest of your VMs in the pentesting lab
- Review the Results
  - Scans > Reports
  - Scans > Results
  - Scans > Vulnerabilities
- Try adding credentials and scanning again
  - Configuration > Credentials

Various Sync commands
- `sudo runuser -u _gvm -- greenbone-nvt-sync`
- `sudo gvm-feed-update`

Using the results:
- Focus on High and Medium; see software information and potential exploits (CVEs)
- Look for exploitable CVEs and if public available exploits exist

## Attack and exploit tools
- Responder - fake server; does relaying; deals with POP IMAP SMTP SQL queries MLMNR, NBT; recover usernames and passwords
- Metasploit - validate and launch exploits (paid version provides GUI)
- ettercap - ARP poisoning

## Miscellaneous tools
- Searchsploit - enables search database of exploits/archive; see if a system may be vulnerable to a specific exploit
