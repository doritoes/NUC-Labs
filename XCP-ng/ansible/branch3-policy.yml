---
- name: Create Branch 3 policy
  hosts: check_point
  connection: httpapi
  collections:
    - check_point.mgmt
  # include_vars: vars.yml # introduced in Ansible 2.11
  tasks:
    - name: update gateways access rule
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: Manage gateways
        relative_position:
          below: Gateways access
        source:
          - Manager
          - branch1_outbound_nat
        destination:
          - firewall2
          -  firewall3
        service:
        - https
        - echo-reply
        - ssh_version_2
        action: Accept
        comments: Allow manage gateways
        track:
          type: Log
        state: present
    - name: update IDC to firewall rule
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: IDC to gateways
        relative_position:
          below: Gateways access
        source:
          - idc-1
        destination:
          - firewall2
          - firewall3
        service:
        - https
        action: Accept
        comments: Allow IDC to remote gateways
        track:
          type: Log
        state: present
    - name: update gateways access rule temporary
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: Manage gateways over Internet
        relative_position:
          below: IDC to gateways
        source:
          - branch1_outbound_nat
        destination:
          - firewall2
          - firewall3
        service:
        - echo-reply
        - ssh_version_2
        action: Accept
        comments: Temporarily allow manage gateways over Internet until VPN tunnel is up
        track:
          type: Log
        state: present
    - name: update stealth rule
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: Stealth rule
        relative_position:
          below: Stealth rules
        source:
          - Any
        destination:
          - firewall2
          - firewall3
        service:
        - Any
        action: Drop
        comments: Protect gateways
        track:
          type: Log
        state: present
    - name: update DMZ rule
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: DMZ applications
        relative_position:
          below: DMZ
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - branch1_dmz
        service:
        - echo-request
        - http
        - https
        action: Drop
        comments: Allow access to DMZ web applications
        track:
          type: Log
        state: present
    - name: i[date core services ntp allowed
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: NTP allowed
        relative_position:
          below: Core Services
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - .time.windows.com
          - .ntp.checkpoint.com
          - .ntp2.checkpoint.com
          - .ntp.ubuntu.com
        service:
        - ntp
        action: Accept
        comments: Approved ntp
        track:
          type: Log
        state: present
    - name: update core services domain controller
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: Domain Services
        relative_position:
          below: NTP allowed
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - dc-1
        service:
        - active_directory_ports
        action: Accept
        comments: domain controller access
        track:
          type: Log
        state: present
    - name: update core services file server
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: File Server
        relative_position:
          below: Domain Services
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - file-1
        service:
        - nbsession
        - smb
        action: Accept
        comments: file server access
        track:
          type: Log
        state: present
    - name: update Internet access rule
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: Web access
        relative_position:
          below: General Internet access
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - All_Internet
        service:
        - http
        - https
        - echo-request
        action: Accept
        comments: Protect gateways
        track:
          type: Log
        state: present
    - name: update noise suppression rule netbios
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: netbios broadcasts
        relative_position:
          below: Noise suppression
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - broadcast_10.0.2.255
          - broadcast_10.0.3.255
        service:
        - nbname
        - nbdatagram
        action: Drop
        comments: Do not log netbios broadcast drops
        track:
          type: None
        state: present
    - name: update noise suppression rule multicast 224.0.0.251
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: mDNS multicast
        relative_position:
          below: netbios broadcasts
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - multicast_224.0.0.251
        service:
        - udp_5353
        action: Drop
        comments: Do not log mDNS drops
        track:
          type: None
        state: present
    - name: update noise suppression rule multicast 239.255.255.250 224.0.0.251 224.0.0.252
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: llmnr and ssdp multicast
        relative_position:
          below: mDNS multicast
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - multicast_224.0.0.251
          - multicast_224.0.0.252
          - multicast_239.255.255.250
        service:
        - udp_1900
        - udp_3702
        - udp_5353
        - udp_5355
        action: Drop
        comments: Do not log LLMNR and SSDP multicast drops
        track:
          type: None
        state: present
    - name: update noise suppression rule multicast 224.0.0.22
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: IGMP multicast
        relative_position:
          below: llmnr and ssdp multicast
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - multicast_224.0.0.22
        service:
        - igmp
        action: Drop
        comments: Do not log mDNS drops
        track:
          type: None
        state: present
    - name: update noise suppression rule quic
      check_point.mgmt.cp_mgmt_access_rule:
        layer: Lab_Policy_Branches Network
        name: quic
        relative_position:
          below: IGMP multicast
        source:
          - branch2_lan
          - branch3_lan
        destination:
          - All_internet
        service:
        - quic
        action: Drop
        comments: explicitly drop quic
        track:
          type: Log
        state: present
    - name: create NAT rule section No-NAT
      check_point.mgmt.cp_mgmt_nat_section:
        package: Lab_Policy_Branches
        name: No-NAT
        position: top
        state: present
    - name: publish changes
      check_point.mgmt.cp_mgmt_publish:
